\hypertarget{ddx__solvers_8f90_source}{}\doxysection{ddx\+\_\+solvers.\+f90}
\label{ddx__solvers_8f90_source}\index{src/ddx\_solvers.f90@{src/ddx\_solvers.f90}}
\mbox{\hyperlink{ddx__solvers_8f90}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00011}00011 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00013}\mbox{\hyperlink{namespaceddx__solvers}{00013}} \textcolor{keyword}{module} \mbox{\hyperlink{namespaceddx__solvers}{ddx\_solvers}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00014}00014 \textcolor{comment}{! Get the core-\/routines}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00015}00015 \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__core}{ddx\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00016}00016 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00017}00017 \textcolor{comment}{! Disable implicit types}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00018}00018 \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00019}00019 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00020}00020 \textcolor{comment}{! Interfaces}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00021}00021 \textcolor{keyword}{interface}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00022}00022     \textcolor{comment}{! Interface for the matrix-\/vector product function}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00023}\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{00023}}     \textcolor{keyword}{subroutine }\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{matvec\_interface}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00024}00024         \textcolor{comment}{!! Add definitions for derived types}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00025}00025         \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__core}{ddx\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00026}00026         \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00027}00027         \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00028}00028         \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00029}00029 \textcolor{keywordtype}{        real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00030}00030         \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00031}00031         \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00032}00032         \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00033}00033 \textcolor{keywordtype}{        real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00034}00034     \textcolor{keyword}{end subroutine }\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{matvec\_interface}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00035}00035 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00036}00036     \textcolor{comment}{! Interface for the matrix-\/vector product function for external jacobi\_diis.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00037}00037     \textcolor{comment}{! note that the dimension of x and y is double for ddlpb.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00038}\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface__external}{00038}}     \textcolor{keyword}{subroutine }\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface__external}{matvec\_interface\_external}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00039}00039         \textcolor{comment}{!! Add definitions for derived types}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00040}00040         \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__core}{ddx\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00041}00041         \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00042}00042         \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00043}00043         \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00044}00044 \textcolor{keywordtype}{        real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00045}00045         \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00046}00046         \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00047}00047         \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00048}00048 \textcolor{keywordtype}{        real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00049}00049     \textcolor{keyword}{end subroutine }\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface__external}{matvec\_interface\_external}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00050}00050 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00051}00051     \textcolor{comment}{! Interface for the norm calculating function}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00052}\mbox{\hyperlink{interfaceddx__solvers_1_1norm__interface}{00052}} \textcolor{keywordtype}{    real}(dp) function norm\_interface(lmax, nbasis, nsph, x)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00053}00053         \textcolor{comment}{!! Add definition for real(dp)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00054}00054         \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__definitions}{ddx\_definitions}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00055}00055         \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00056}00056         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: lmax, nbasis, nsph}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00057}00057 \textcolor{keywordtype}{        real}(dp), \textcolor{keywordtype}{intent(in)} :: x(nbasis, nsph)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00058}00058     \textcolor{keyword}{end function }\mbox{\hyperlink{interfaceddx__solvers_1_1norm__interface}{norm\_interface}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00059}00059 \textcolor{keyword}{end interface}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00060}00060 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00061}00061 \textcolor{keyword}{contains}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00062}00062 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00080}\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{00080}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}(params, constants, workspace, tol, rhs, x, niter, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00081}00081         \& x\_rel\_diff, matvec, dm1vec, norm\_func, info)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00082}00082     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00083}00083     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00084}00084     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00085}00085 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: tol, rhs(constants \% n)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00086}00086     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00087}00087     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00088}00088     \textcolor{comment}{!! Outputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00089}00089 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(inout)} :: x(constants \% n)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00090}00090     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(inout)} :: niter}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00091}00091 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: x\_rel\_diff(niter)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00092}00092     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(out)} :: info}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00093}00093     \textcolor{comment}{!! External procedures}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00094}00094     \textcolor{keywordtype}{procedure}(\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{matvec\_interface}}) :: matvec, dm1vec}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00095}00095     \textcolor{keywordtype}{procedure}(\mbox{\hyperlink{interfaceddx__solvers_1_1norm__interface}{norm\_interface}}) :: norm\_func}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00096}00096     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00097}00097     \textcolor{keywordtype}{integer} :: it, nmat}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00098}00098 \textcolor{keywordtype}{    real}(dp) :: diff, norm, rel\_diff}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00099}00099     \textcolor{comment}{!! The code}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00100}00100     \textcolor{comment}{! DIIS variable}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00101}00101     nmat = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00102}00102     \textcolor{comment}{! Iterations}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00103}00103     \textcolor{keywordflow}{do} it = 1, niter}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00104}00104         \textcolor{comment}{! y = rhs -\/ O x}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00105}00105         \textcolor{keyword}{call }matvec(params, constants, workspace, x, workspace \% tmp\_y)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00106}00106         workspace \% tmp\_y = rhs -\/ workspace \% tmp\_y}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00107}00107         \textcolor{comment}{! x\_new = D\string^-\/1 y}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00108}00108         \textcolor{keyword}{call }dm1vec(params, constants, workspace, workspace \% tmp\_y, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00109}00109             \& workspace \% tmp\_x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00110}00110         \textcolor{comment}{! DIIS extrapolation}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00111}00111         \textcolor{keywordflow}{if} (params \% jacobi\_ndiis .gt. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00112}00112             workspace \% tmp\_x\_diis(:, nmat) = workspace \% tmp\_x\_new}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00113}00113             workspace \% tmp\_e\_diis(:, nmat) = workspace \% tmp\_x\_new -\/ x}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00114}00114             \textcolor{keyword}{call }diis(constants \% n, nmat, params \% jacobi\_ndiis, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00115}00115                 \& workspace \% tmp\_x\_diis, workspace \% tmp\_e\_diis, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00116}00116                 \& workspace \% tmp\_bmat, workspace \% tmp\_x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00117}00117 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00118}00118         \textcolor{comment}{! Norm of increment}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00119}00119         x = workspace \% tmp\_x\_new -\/ x}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00120}00120         diff = norm\_func(params \% lmax, constants \% nbasis, params \% nsph, x)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00121}00121         norm = norm\_func(params \% lmax, constants \% nbasis, params \% nsph, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00122}00122             \& workspace \% tmp\_x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00123}00123 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00124}00124         \textcolor{comment}{! compute rel\_diff using the rule 0/0 = 0}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00125}00125         \textcolor{keywordflow}{if} (diff.eq.zero .and. norm.eq.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00126}00126             rel\_diff = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00127}00127         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00128}00128             rel\_diff = diff / norm}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00129}00129 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00130}00130 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00131}00131         x\_rel\_diff(it) = rel\_diff}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00132}00132         \textcolor{comment}{! Update solution}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00133}00133         x = workspace \% tmp\_x\_new}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00134}00134         \textcolor{comment}{! Check stop condition}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00135}00135         \textcolor{keywordflow}{if} (rel\_diff .le. tol) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00136}00136             info = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00137}00137             niter = it}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00138}00138             \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00139}00139 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00140}00140 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00141}00141     info = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00142}00142 \textcolor{keyword}{endsubroutine }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00143}00143 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00144}00144 \textcolor{keyword}{subroutine }diis(n, nmat, ndiis, x, e, b, xnew)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00145}00145     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00146}00146     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: n, ndiis}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00147}00147     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(inout)} :: nmat}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00148}00148 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(n,ndiis)}, \textcolor{keywordtype}{intent(inout)} :: x, e}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00149}00149 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(ndiis+1,ndiis+1)}, \textcolor{keywordtype}{intent(inout)} :: b}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00150}00150 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(n)}, \textcolor{keywordtype}{intent(inout)} :: xnew}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00151}00151     \textcolor{keywordtype}{integer} :: nmat1, i, istatus, info}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00152}00152     \textcolor{keywordtype}{integer} :: j, k}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00153}00153 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{allocatable} :: bloc(:,:), cex(:)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00154}00154     \textcolor{keywordtype}{integer},  \textcolor{keywordtype}{allocatable} :: ipiv(:)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00155}00155 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{parameter} :: zero = 0.0d0, one = 1.0d0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00156}00156     \textcolor{keywordtype}{integer},  \textcolor{keywordtype}{parameter} :: delta = 10}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00157}00157 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00158}00158     \textcolor{keywordflow}{if} (nmat.ge.ndiis) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00159}00159         \textcolor{keywordflow}{do} j = 2, nmat -\/ delta}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00160}00160             \textcolor{keywordflow}{do} k = 2, nmat -\/ delta}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00161}00161                 b(j, k) = b(j+delta, k+delta)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00162}00162 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00163}00163 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00164}00164         \textcolor{keywordflow}{do} j = 1, nmat -\/ delta}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00165}00165             x(:, j) = x(:, j+delta)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00166}00166             e(:, j) = e(:, j+delta)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00167}00167 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00168}00168         nmat = nmat -\/ delta}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00169}00169 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00170}00170     nmat1 = nmat + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00171}00171 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00172}00172     \textcolor{keyword}{allocate}(bloc(nmat1, nmat1), cex(nmat1), ipiv(nmat1), stat=istatus)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00173}00173     \textcolor{keywordflow}{if} (istatus.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00174}00174         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'diis: allocation failed!'}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00175}00175         stop}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00176}00176 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00177}00177 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00178}00178     \textcolor{keyword}{call }makeb(n, nmat, ndiis, e, b)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00179}00179     bloc = b(1:nmat1, 1:nmat1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00180}00180     cex = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00181}00181     cex(1) = one}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00182}00182     \textcolor{keyword}{call }dgesv(nmat1, 1, bloc, nmat1, ipiv, cex, nmat1, info)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00183}00183 \textcolor{comment}{!   call gjinv(nmat1, 1, bloc, cex, ok)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00184}00184     \textcolor{keywordflow}{if} (info.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00185}00185         nmat = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00186}00186         \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00187}00187 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00188}00188 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00189}00189     xnew = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00190}00190     \textcolor{keywordflow}{do} i = 1, nmat}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00191}00191         \textcolor{keyword}{call }daxpy(n,cex(i+1),x(:, i),1,xnew,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00192}00192 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00193}00193     nmat = nmat + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00194}00194 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00195}00195     \textcolor{keyword}{deallocate} (bloc, cex, stat=istatus)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00196}00196     \textcolor{keywordflow}{if} (istatus.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00197}00197         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'diis: deallocation failed!'}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00198}00198         stop}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00199}00199 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00200}00200 \textcolor{keyword}{end subroutine }diis}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00201}00201 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00202}00202 \textcolor{keyword}{subroutine }makeb(n, nmat, ndiis, e, b)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00203}00203     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00204}00204     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: n, nmat, ndiis}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00205}00205 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(n,ndiis)}, \textcolor{keywordtype}{intent(in)} :: e}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00206}00206 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(ndiis+1,ndiis+1)}, \textcolor{keywordtype}{intent(inout)} :: b}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00207}00207 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00208}00208     \textcolor{keywordtype}{integer} :: i}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00209}00209 \textcolor{keywordtype}{    real}(dp) :: bij}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00210}00210 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{parameter} :: zero = 0.0d0, one = 1.0d0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00211}00211 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00212}00212     \textcolor{comment}{! 1st built}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00213}00213     \textcolor{keywordflow}{if} (nmat.eq.1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00214}00214 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00215}00215         \textcolor{comment}{!     [ 0 |  1  ]}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00216}00216         \textcolor{comment}{! b = [ -\/-\/+-\/-\/-\/-\/ ]}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00217}00217         \textcolor{comment}{!     [ 1 | e*e ]}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00218}00218 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00219}00219         b(1,1) = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00220}00220         b(1,2) = one}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00221}00221         b(2,1) = one}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00222}00222         b(2,2) = dot\_product(e(:,1),e(:,1))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00223}00223 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00224}00224     \textcolor{comment}{! subsequent builts}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00225}00225     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00226}00226 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00227}00227         \textcolor{comment}{! first, update the lagrangian line:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00228}00228         b(nmat+1,1) = one}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00229}00229         b(1,nmat+1) = one}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00230}00230 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00231}00231         \textcolor{comment}{! now, compute the new matrix elements:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00232}00232         \textcolor{comment}{!\$omp parallel do default(none) shared(nmat,e,b) \&}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00233}00233         \textcolor{comment}{!\$omp private(i,bij) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00234}00234         \textcolor{keywordflow}{do} i = 1, nmat -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00235}00235             bij = dot\_product(e(:,i), e(:,nmat))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00236}00236             b(nmat+1, i+1) = bij}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00237}00237             b(i+1, nmat+1) = bij}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00238}00238 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00239}00239         b(nmat+1,nmat+1) = dot\_product(e(:,nmat),e(:,nmat))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00240}00240 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00241}00241 \textcolor{keyword}{end subroutine }makeb}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00242}00242 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00243}00243 \textcolor{comment}{!*********************************************************}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00244}00244 \textcolor{comment}{! GMRESR algorithm to solve linear system Ax = b}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00245}00245 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00246}00246 \textcolor{comment}{!  author:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00247}00247 \textcolor{comment}{!  m.botchev, utrecht university, december 1996}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00248}00248 \textcolor{comment}{!  report bugs to botchev@cwi.nl or botchev@excite.com}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00249}00249 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00250}00250 \textcolor{comment}{! Copyright (c) 1996 by M.A.Botchev}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00251}00251 \textcolor{comment}{! Permission to copy all or part of this work is granted,}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00252}00252 \textcolor{comment}{! provided that the copies are not made or distributed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00253}00253 \textcolor{comment}{! for resale, and that the copyright notice and this}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00254}00254 \textcolor{comment}{! notice are retained.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00255}00255 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00256}00256 \textcolor{comment}{! Details to the algorithm may be found in}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00257}00257 \textcolor{comment}{!  H.A. van der Vorst, !. Vuik, "{}GMRESR: a Family of Nested GMRES}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00258}00258 \textcolor{comment}{!  Methods"{}, Num. Lin. Alg. Appl., vol. 1(4), 369-\/-\/386 (1994)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00259}00259 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00260}00260 \textcolor{comment}{! parameter list:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00261}00261 \textcolor{comment}{! oktest is TRUE if intermediate residuals should be printed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00262}00262 \textcolor{comment}{! n      == INTEGER size of problem}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00263}00263 \textcolor{comment}{! j      == INTEGER truncation parameter (work with j last vectors)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00264}00264 \textcolor{comment}{! mgmres == INTEGER dimension of the envoked GMRES}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00265}00265 \textcolor{comment}{!           if mgmres.eq.0 then we get GCR algorithm, the simplest}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00266}00266 \textcolor{comment}{!           version of GMRESR }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00267}00267 \textcolor{comment}{! b      == DOUBLE PRECISION righthand side vector}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00268}00268 \textcolor{comment}{! x      == DOUBLE PRECISION initial guess on input,}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00269}00269 \textcolor{comment}{!           (approximate) solution on output}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00270}00270 \textcolor{comment}{! work   == DOUBLE PRECISION work space 1 of size n x (2*j+mgmres+2)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00271}00271 \textcolor{comment}{! eps    == DOUBLE PRECISION tolerance of stopping criterion. }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00272}00272 \textcolor{comment}{!           process is stopped as soon as }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00273}00273 \textcolor{comment}{!           (1) residual norm has been dumped by factor eps, }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00274}00274 \textcolor{comment}{!           i.e.  ||res|| / ||b|| <= eps   OR}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00275}00275 \textcolor{comment}{!           (2) maximum number of iterations maxit has been performed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00276}00276 \textcolor{comment}{! stc    == CHARACTER*3}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00277}00277 \textcolor{comment}{!           Determine stopping criterion (||.|| denotes the 2-\/norm):}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00278}00278 \textcolor{comment}{!           stc='rel'    -\/-\/ relative stopping crit.: ||res|| < eps*||res0||}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00279}00279 \textcolor{comment}{!           stc='abs'    -\/-\/ absolute stopping crit.: ||res|| < eps}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00280}00280 \textcolor{comment}{! maxits == INTEGER max. no. outer\_iterative\_steps/truncation\_length on input}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00281}00281 \textcolor{comment}{!           on output it is the actual number of total iterative steps   }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00282}00282 \textcolor{comment}{! resid  == DOUBLE PRECISION residual measure (depends on stopping criterion)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00283}00283 \textcolor{comment}{!           achieved on output }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00284}00284 \textcolor{comment}{! iflag  == INTEGER on output 0 -\/ solution found within tolerance}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00285}00285 \textcolor{comment}{!                             1 -\/ no convergence within niter}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00286}00286 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00287}00287 \textcolor{keyword}{subroutine }gmresr(params, constants, workspace, eps, b, x, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00288}00288                 \& niter, resid, matvec, info)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00289}00289     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00290}00290     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00291}00291     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00292}00292 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: eps, b(constants \% n)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00293}00293     \textcolor{comment}{!! Outputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00294}00294 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(inout)} :: x(constants \% n)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00295}00295     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(inout)} :: niter}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00296}00296     \textcolor{comment}{!real(dp), intent(out) :: x\_rel\_diff(niter)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00297}00297     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(out)} :: info}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00298}00298     \textcolor{comment}{!! Temporary buffers}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00299}00299     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00300}00300     \textcolor{comment}{!! External procedures}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00301}00301     \textcolor{keywordtype}{procedure}(\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{matvec\_interface}}) :: matvec}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00302}00302     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00303}00303 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00304}00304 \textcolor{comment}{!     list of variables: arrays in alphabetical order,}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00305}00305 \textcolor{comment}{!     then other variables in alphabetical order}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00306}00306 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00307}00307       \textcolor{keywordtype}{integer} i,its,nits,itsinn,k,n,j}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00308}00308 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00309}00309       \textcolor{keywordtype}{double precision} alpha, alphai, cknorm, ckres, ddot, dnrm2, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00310}00310                        \& epsinn, res0,resnor,resid}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00311}00311 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00312}00312 \textcolor{comment}{! distribute work space work(n,*) among some virtual variables;}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00313}00313 \textcolor{comment}{! namely, we think of columns of work as being occupied by }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00314}00314 \textcolor{comment}{! c(n,0:j-\/1), u(n,0:j-\/1), resid(n), workgmr(n,params \% gmresr\_dim+1)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00315}00315 \textcolor{comment}{! therefore we define "{}shifts"{}}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00316}00316 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00317}00317       \textcolor{keywordtype}{integer} c, u, workres, workgmre}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00318}00318 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00319}00319 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00320}00320       \textcolor{comment}{! Read j and n from the parameters}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00321}00321       j = params \% gmresr\_j}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00322}00322       n = constants \% n}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00323}00323 \textcolor{comment}{!     c occupies j columns 0...j-\/1:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00324}00324       c = 0 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00325}00325 \textcolor{comment}{!     u occupies j columns j...2*j-\/1:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00326}00326       u = params \% gmresr\_j}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00327}00327 \textcolor{comment}{!     resid occupies 1 column No. 2*j:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00328}00328       workres = 2*j    }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00329}00329 \textcolor{comment}{!     workgmre occupies gmres\_dim+1 columns 2*j+1...2*j+gmres\_dim+1:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00330}00330       workgmre = 2*j+1 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00331}00331 \textcolor{comment}{!     so that we can access, say, to the (k)th column of the virtual}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00332}00332 \textcolor{comment}{!     array c(n,0:j-\/1) as work(1,c+k),}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00333}00333 \textcolor{comment}{!     virtual residual vector resid(n) is work(1,workres) and so on ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00334}00334 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00335}00335 \textcolor{comment}{! ***Furthermore, we build sequences c\_k and u\_k, k = 0,...,m-\/1}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00336}00336 \textcolor{comment}{! but we store only the last j vectors in the following way:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00337}00337 \textcolor{comment}{! Assume j=3, then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00338}00338 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00339}00339 \textcolor{comment}{!  k    |  number of column of work | columns of work which are vectors}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00340}00340 \textcolor{comment}{!       |  in which we store c\_k    |  we actually store and use}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00341}00341 \textcolor{comment}{!  0    |           0               |   c\_0             u\_0            ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00342}00342 \textcolor{comment}{!  1    |           1               |   c\_0  c\_1        u\_0  u\_1       ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00343}00343 \textcolor{comment}{!  2    |           2               |   c\_0  c\_1  c\_2   u\_0  u\_1  u\_2  ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00344}00344 \textcolor{comment}{!  3    |           0               |   c\_3  c\_1  c\_2   u\_3  u\_1  u\_2  ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00345}00345 \textcolor{comment}{!  4    |           1               |   c\_3  c\_4  c\_2   u\_3  u\_4  u\_2  ... }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00346}00346 \textcolor{comment}{!  5    |           2               |   c\_3  c\_4  c\_5   u\_3  u\_4  u\_5  ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00347}00347 \textcolor{comment}{!  6    |           0               |   c\_6  c\_4  c\_5   u\_6  u\_4  u\_5  ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00348}00348 \textcolor{comment}{! ...   |           ...             |      ...               ...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00349}00349 \textcolor{comment}{! This mapping is performed by function mod(k,j)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00350}00350 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00351}00351 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00352}00352 \textcolor{comment}{!     Reset iteration counter}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00353}00353       nits= 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00354}00354       its = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00355}00355 \textcolor{comment}{!     Calculate (initial) residual norm}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00356}00356       \textcolor{keyword}{call }matvec(params, constants, workspace, x, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00357}00357           \& workspace \% tmp\_gmresr(1, workres))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00358}00358       alpha = -\/1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00359}00359 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00360}00360       \textcolor{keyword}{call }daxpy(n, alpha, b, 1, workspace \% tmp\_gmresr(1, workres), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00361}00361       \textcolor{keyword}{call }dscal(n, alpha, workspace \% tmp\_gmresr(1, workres), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00362}00362 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00363}00363 \textcolor{comment}{!     Calculate residual norm and quit if it is zero}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00364}00364       res0 = dnrm2(n, b, 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00365}00365       resnor = res0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00366}00366       resid = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00367}00367 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00368}00368       \textcolor{keywordflow}{if} ( res0 .eq. 0.0d0 ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00369}00369          info = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00370}00370          niter = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00371}00371          \textcolor{keywordflow}{return}  }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00372}00372 \textcolor{keywordflow}{      end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00373}00373 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00374}00374       resid=resnor/res0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00375}00375 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00376}00376       \textcolor{keywordflow}{if} ( resid .le. eps ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00377}00377          info = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00378}00378          niter = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00379}00379          \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00380}00380 \textcolor{keywordflow}{      end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00381}00381  }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00382}00382 \textcolor{comment}{!     Main iterative loop ============================}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00383}00383       k = -\/1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00384}00384       \textcolor{keywordflow}{do} \textcolor{keywordflow}{while} (.true.)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00385}00385 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00386}00386 \textcolor{comment}{!        Loop to increment dimension of projection subspace}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00387}00387          k=k+1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00388}00388 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00389}00389 \textcolor{comment}{!        Number of step (not restart) to be done}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00390}00390          its = its + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00391}00391 \textcolor{comment}{!        write(*,'(A,i3)') '+++++++++++++++++ its ',its }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00392}00392 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00393}00393 \textcolor{comment}{!        -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00394}00394 \textcolor{comment}{!        This part should deliver }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00395}00395 \textcolor{comment}{!        u(1,k) <-\/-\/ invA * resid}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00396}00396 \textcolor{comment}{!        where u(1,k) is the k-\/th column of array u(1:n,0:m) and}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00397}00397 \textcolor{comment}{!        invA is some reasonable approximation to the inverse of A}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00398}00398 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00399}00399 \textcolor{comment}{!        If gmres\_dim=0 then no inner iterations are performed }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00400}00400 \textcolor{comment}{!        to get invA, so that invA is just the identity matrix. }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00401}00401 \textcolor{comment}{!        In this case algorithm GMRESR is nothing but GCR}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00402}00402 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00403}00403 \textcolor{comment}{!        Otherwise for inner iterations we perform ONE restart of GMRES}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00404}00404 \textcolor{comment}{!        ATTN: for this implementation it is crucial to perform only}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00405}00405 \textcolor{comment}{!        ONE restart of GMRES}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00406}00406          \textcolor{keywordflow}{if} (params \% gmresr\_dim .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00407}00407 \textcolor{comment}{!           u(1,k) := resid  }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00408}00408             \textcolor{keyword}{call }dcopy(n, workspace \% tmp\_gmresr(1, workres), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00409}00409                 \& workspace \% tmp\_gmresr(1, u+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00410}00410             \textcolor{keyword}{call }matvec(params, constants, workspace, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00411}00411                 \& workspace \% tmp\_gmresr(1, u+mod(k,j)), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00412}00412                 \& workspace \% tmp\_gmresr(1, c+mod(k,j)))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00413}00413             nits=nits+1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00414}00414          \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00415}00415 \textcolor{comment}{!           Solve linear system A*u(1,k)=resid by GMRES}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00416}00416 \textcolor{comment}{!           The stopping criterion for inner iterations is }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00417}00417 \textcolor{comment}{!           always absolute but it is automatically adjusted}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00418}00418 \textcolor{comment}{!           not to be stricter than the stopping criterion for the }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00419}00419 \textcolor{comment}{!           outer iterations.  For example, if stop.criterion for}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00420}00420 \textcolor{comment}{!           the outer iterations is relative than absolute stop.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00421}00421 \textcolor{comment}{!           criterion for the inner iterations is (eps*res0)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00422}00422 \textcolor{comment}{!           Accuracy for inner iteration:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00423}00423 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00424}00424                epsinn = eps*res0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00425}00425 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00426}00426 \textcolor{comment}{!           After envoking gmres0 epsinn and itsinn contain actual achieved}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00427}00427 \textcolor{comment}{!           accuracy and number of performed iterations respectively}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00428}00428 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00429}00429             itsinn=params \% gmresr\_dim}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00430}00430 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00431}00431             \textcolor{keyword}{call }gmres0(params, constants, workspace, n, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00432}00432                        \& workspace \% tmp\_gmresr(1, workres), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00433}00433                        \& workspace \% tmp\_gmresr(1, u+mod(k,j)), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00434}00434                        \& workspace \% tmp\_gmresr(1, c+mod(k,j)), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00435}00435                        \& workspace \% tmp\_gmresr(1, workgmre), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00436}00436                        \& epsinn,itsinn,matvec)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00437}00437             \textcolor{comment}{!write(*,*) 'GMRES ', work(1,c+mod(k,j))}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00438}00438 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00439}00439             nits=nits+itsinn}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00440}00440 \textcolor{keywordflow}{         end if}           }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00441}00441 \textcolor{comment}{! -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00442}00442       }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00443}00443 \textcolor{comment}{!        Inner loop to orthogonalize }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00444}00444 \textcolor{comment}{!        c(1,k) with respect to c(1,k-\/j),...,c(1,k-\/1)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00445}00445 \textcolor{comment}{!        and to update correspondingly }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00446}00446 \textcolor{comment}{!        u(1,k) with respect to u(1,k-\/j),...,u(1,k-\/1)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00447}00447 \textcolor{comment}{!        parameter j is used only here}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00448}00448          \textcolor{keywordflow}{do} i = max0(0,k-\/j),k-\/1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00449}00449             alphai = ddot(n, workspace \% tmp\_gmresr(1, c+mod(i,j)), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00450}00450                 \& workspace \% tmp\_gmresr(1, c+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00451}00451             \textcolor{keyword}{call }daxpy(n, -\/alphai, workspace \% tmp\_gmresr(1, c+mod(i,j)), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00452}00452                 \& workspace \% tmp\_gmresr(1, c+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00453}00453             \textcolor{keyword}{call }daxpy(n, -\/alphai, workspace \% tmp\_gmresr(1, u+mod(i,j)), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00454}00454                 \& workspace \% tmp\_gmresr(1, u+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00455}00455 \textcolor{keywordflow}{         end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00456}00456 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00457}00457 \textcolor{comment}{!        Normalize c(1,k) and "{}normalize"{} u(1,k)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00458}00458          cknorm = dnrm2(n, workspace \% tmp\_gmresr(1, c+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00459}00459          cknorm = 1 / cknorm}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00460}00460          \textcolor{keyword}{call }dscal(n, cknorm, workspace \% tmp\_gmresr(1, c+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00461}00461          \textcolor{keyword}{call }dscal(n, cknorm, workspace \% tmp\_gmresr(1, u+mod(k,j)), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00462}00462 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00463}00463 \textcolor{comment}{!        Update current solution and residual}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00464}00464          ckres = ddot(n, workspace \% tmp\_gmresr(1, c+mod(k,j)), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00465}00465              \& workspace \% tmp\_gmresr(1, workres), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00466}00466          \textcolor{keyword}{call }daxpy(n, ckres, workspace \% tmp\_gmresr(1, u+mod(k,j)), 1, x, 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00467}00467          \textcolor{keyword}{call }daxpy(n, -\/ckres, workspace \% tmp\_gmresr(1, c+mod(k,j)), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00468}00468              \& workspace \% tmp\_gmresr(1, workres), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00469}00469          }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00470}00470 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00471}00471 \textcolor{comment}{!        call show(n,10,x,'GMRESR       ')  }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00472}00472 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00473}00473 \textcolor{comment}{!        Calculate residual norm, check convergence}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00474}00474          resnor = dnrm2(n, workspace \% tmp\_gmresr(1, workres), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00475}00475 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00476}00476             resid=resnor/res0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00477}00477 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00478}00478          \textcolor{keywordflow}{if} ( resid .le. eps ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00479}00479             info = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00480}00480             niter = nits}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00481}00481             \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00482}00482 \textcolor{keywordflow}{         end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00483}00483          \textcolor{keywordflow}{if} (its .ge. niter*j) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00484}00484             info = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00485}00485             niter = nits}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00486}00486             \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00487}00487 \textcolor{keywordflow}{         end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00488}00488 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00489}00489 \textcolor{comment}{!        print 11, '            ||res|| = ',resnor }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00490}00490 \textcolor{comment}{! 11     format(A,d)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00491}00491 \textcolor{comment}{! 13     format(i4,A,d)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00492}00492       }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00493}00493 \textcolor{keywordflow}{      end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00494}00494 \textcolor{comment}{! End of inifinite iterative loop =================}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00495}00495 \textcolor{comment}{! End of GMRESR subroutine      }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00496}00496       \textcolor{keyword}{end }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00497}00497 \textcolor{comment}{! This is the modified GMRES routine gmres0 adapted for GMRESR by }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00498}00498 \textcolor{comment}{! Mike Botchev, Utrecht University, Dec. 1996}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00499}00499 \textcolor{comment}{! For detail on how to make GMRES (for GMRESR) cheaper see }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00500}00500 \textcolor{comment}{! the above-\/mentioned paper on GMRESR }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00501}00501 \textcolor{comment}{!*************************************************************}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00502}00502 \textcolor{comment}{! This code was initially written by Youcef Saad}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00503}00503 \textcolor{comment}{! then revised by Henk A. van der Vorst  }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00504}00504 \textcolor{comment}{! and Mike Botchev (oct. 1996)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00505}00505 \textcolor{comment}{! ************************************************************ }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00506}00506 \textcolor{comment}{! gmres algorithm . simple version .  (may 23, 1985)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00507}00507 \textcolor{comment}{! parameter list:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00508}00508 \textcolor{comment}{! oktest == TRUE for printing intermediate results}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00509}00509 \textcolor{comment}{! n      == size of problem}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00510}00510 \textcolor{comment}{! im     == size of krylov subspace:  should not exceed 50 in this}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00511}00511 \textcolor{comment}{!          version (can be reset in code. looking at comment below)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00512}00512 \textcolor{comment}{! rhs    == right hand side}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00513}00513 \textcolor{comment}{! uu     == initial guess for vector u (see above-\/mentioned paper on GMRESR)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00514}00514 \textcolor{comment}{!           on input, approximate solution on output}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00515}00515 \textcolor{comment}{! cc     == initial guess for vector c (see above-\/mentioned paper on GMRESR)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00516}00516 \textcolor{comment}{!           on input, approximate solution on output}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00517}00517 \textcolor{comment}{! work0  == work space of size n x (im+1)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00518}00518 \textcolor{comment}{! eps    == tolerance for stopping criterion. process is stopped}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00519}00519 \textcolor{comment}{!           as soon as ( ||.|| is the euclidean norm):}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00520}00520 \textcolor{comment}{!           || current residual || <= eps  }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00521}00521 \textcolor{comment}{! maxits == maximum number of iterations allowed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00522}00522 \textcolor{comment}{!           on OUTPUT: actual number of iterations performed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00523}00523 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00524}00524 \textcolor{comment}{! subroutines }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00525}00525 \textcolor{comment}{! matvec      == matrix vector multiplication y <-\/ A*x}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00526}00526 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00527}00527 \textcolor{comment}{! BLAS:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00528}00528 \textcolor{comment}{! dcopy       == y <-\/-\/ x routine}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00529}00529 \textcolor{comment}{! ddot        == dot product function}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00530}00530 \textcolor{comment}{! dnrm2       == euclidean norm function}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00531}00531 \textcolor{comment}{! daxpy       == y <-\/-\/ y+ax routine}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00532}00532 \textcolor{comment}{! dscal       == x <-\/-\/ ax routine}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00533}00533 \textcolor{comment}{! dtsrv       == to solve linear system with a triangular matrix}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00534}00534 \textcolor{comment}{!*************************************************************}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00535}00535 \textcolor{comment}{!-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00536}00536 \textcolor{comment}{! arnoldi size should not exceed 10 in this version..}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00537}00537 \textcolor{comment}{! to reset modify maxdim. BUT:             -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00538}00538 \textcolor{comment}{! maxdim was set to 10 because of two reasons:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00539}00539 \textcolor{comment}{! (1) it is assumed in this implementation that it is cheaper to}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00540}00540 \textcolor{comment}{! make maxdim vector updates than to make 1 matrix-\/vector}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00541}00541 \textcolor{comment}{! multiplication;}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00542}00542 \textcolor{comment}{! (2) for large maxdim we may lose the orthogonality property}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00543}00543 \textcolor{comment}{! on which this cheap implementation is based.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00544}00544 \textcolor{comment}{! Please keep it in mind changing maxdim}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00545}00545 \textcolor{comment}{!-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00546}00546 \textcolor{comment}{!=============================================================================}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00547}00547 \textcolor{keyword}{subroutine }gmres0(params, constants, workspace, n, rhs, uu, cc, work0, eps, niter, matvec)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00548}00548 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00549}00549     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00550}00550     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00551}00551     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00552}00552     \textcolor{comment}{!! Temporary buffers}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00553}00553     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00554}00554       \textcolor{keywordtype}{integer} maxdim,maxd1,md1max}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00555}00555       parameter(maxdim=20, maxd1=maxdim+1, md1max=maxdim*maxd1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00556}00556     \textcolor{keywordtype}{procedure}(\mbox{\hyperlink{interfaceddx__solvers_1_1matvec__interface}{matvec\_interface}}) :: matvec}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00557}00557 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00558}00558       \textcolor{keywordtype}{integer} jjj,jj1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00559}00559       \textcolor{keywordtype}{integer} i,i1,its,j,k,k1,niter,n}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00560}00560       \textcolor{keywordtype}{double precision} cc(n),coeff,coef1,dabs,ddot,dnrm2,dsqrt,eps,epsmac, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00561}00561                       \& gam,rhs(n),ro,uu(n),work0(n,params \% gmresr\_dim+1),t     }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00562}00562 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00563}00563       \textcolor{keywordtype}{double precision} hh(maxd1,maxdim),hh1(maxd1,maxdim),c(maxdim), \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00564}00564                       \& s(maxdim),rs(maxd1),rs1(maxd1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00565}00565 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00566}00566       \textcolor{keyword}{data} (( hh(jj1,jjj), jj1=1,maxd1), jjj=1,maxdim) / md1max*0.0 / ,\&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00567}00567                       \& epsmac / 1.d-\/16 / }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00568}00568       its = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00569}00569 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00570}00570 \textcolor{comment}{!     -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00571}00571 \textcolor{comment}{!     Outer loop starts here.. }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00572}00572 \textcolor{comment}{!     BUT here (for GMRESR) only 1 outer loop is allowed}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00573}00573 \textcolor{comment}{!     Compute initial residual vector }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00574}00574 \textcolor{comment}{!     -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00575}00575  10   \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00576}00576 \textcolor{comment}{!        do not calculate initial residual first restart because }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00577}00577 \textcolor{comment}{!        initial guess is always zero. }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00578}00578 \textcolor{comment}{!        make initial guess zero:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00579}00579          coeff = 0.0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00580}00580          \textcolor{keyword}{call }dscal(n,coeff,uu,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00581}00581 \textcolor{comment}{!        make initial residual right-\/hand side:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00582}00582          \textcolor{keyword}{call }dcopy(n,rhs,1,work0,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00583}00583 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00584}00584          ro = dnrm2(n, work0, 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00585}00585          \textcolor{keywordflow}{if} ((ro .eq. 0.0d0).or.(ro .le. eps)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00586}00586             \textcolor{keyword}{call }matvec(params, constants, workspace, uu, cc)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00587}00587             eps = ro}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00588}00588             niter = its }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00589}00589             \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00590}00590 \textcolor{keywordflow}{         end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00591}00591 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00592}00592          coeff = 1 / ro}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00593}00593          \textcolor{keyword}{call }dscal(n,coeff,work0,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00594}00594 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00595}00595 \textcolor{comment}{!        initialize 1-\/st term  of rhs of hessenberg system..}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00596}00596          rs(1) = ro}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00597}00597          i = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00598}00598 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00599}00599  4       \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00600}00600             i=i+1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00601}00601             its = its + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00602}00602             i1 = i + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00603}00603             \textcolor{keyword}{call  }matvec(params, constants, workspace, work0(1,i), work0(1,i1))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00604}00604 \textcolor{comment}{!           -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00605}00605 \textcolor{comment}{!           modified gram -\/ schmidt...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00606}00606 \textcolor{comment}{!           -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00607}00607             \textcolor{keywordflow}{do} j=1, i}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00608}00608                t = ddot(n, work0(1,j),1,work0(1,i1),1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00609}00609                hh(j,i) = t}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00610}00610                \textcolor{keyword}{call }daxpy(n, -\/t, work0(1,j), 1, work0(1,i1), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00611}00611 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00612}00612             t = dnrm2(n, work0(1,i1), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00613}00613             hh(i1,i) = t}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00614}00614             \textcolor{keywordflow}{if} (t .ne. 0.0d0)\textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00615}00615                t = 1 / t}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00616}00616                \textcolor{keyword}{call }dscal(n, t, work0(1,i1), 1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00617}00617 \textcolor{comment}{!              save new column of hh in hh1 to reproduce vector cc later on}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00618}00618                \textcolor{keyword}{call }dcopy(maxd1,hh(1,i),1,hh1(1,i),1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00619}00619 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00620}00620 \textcolor{comment}{!           done with modified gram schmidt and arnoldi step..}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00621}00621 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00622}00622 \textcolor{comment}{!           now  update factorization of hh}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00623}00623             \textcolor{keywordflow}{if} (i .ne. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00624}00624 \textcolor{comment}{!              perform previous transformations  on i-\/th column of h}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00625}00625                \textcolor{keywordflow}{do} k=2,i}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00626}00626                   k1 = k-\/1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00627}00627                   t = hh(k1,i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00628}00628                   hh(k1,i) = c(k1)*t + s(k1)*hh(k,i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00629}00629                   hh(k,i) = -\/s(k1)*t + c(k1)*hh(k,i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00630}00630 \textcolor{keywordflow}{               end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00631}00631 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00632}00632             gam = dsqrt(hh(i,i)**2 + hh(i1,i)**2)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00633}00633             \textcolor{keywordflow}{if} (gam .eq. 0.0d0) gam = epsmac}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00634}00634 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00635}00635 \textcolor{comment}{!           determine next plane rotation}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00636}00636             c(i) = hh(i,i)/gam}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00637}00637             s(i) = hh(i1,i)/gam}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00638}00638             rs(i1) = -\/s(i)*rs(i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00639}00639             rs(i) =  c(i)*rs(i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00640}00640 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00641}00641 \textcolor{comment}{!           determine residual norm and test for convergence-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00642}00642             hh(i,i) = c(i)*hh(i,i) + s(i)*hh(i1,i)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00643}00643             ro = dabs(rs(i1))}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00644}00644          \textcolor{keywordflow}{if} ((i .lt. params \% gmresr\_dim) .and. (ro .gt. eps))  \textcolor{keywordflow}{goto} 4}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00645}00645 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00646}00646 \textcolor{comment}{!        now compute solution. first solve upper triangular system.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00647}00647 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00648}00648 \textcolor{comment}{!        rs := hh(1:i,1:i) \string^-\/1 * rs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00649}00649 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00650}00650          \textcolor{keyword}{call }dtrsv(\textcolor{stringliteral}{'U'},\textcolor{stringliteral}{'N'},\textcolor{stringliteral}{'N'},i,hh,maxd1,rs,1)   }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00651}00651 \textcolor{comment}{!        done with back substitution..}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00652}00652 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00653}00653 \textcolor{comment}{!        now form linear combination to get vector uu}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00654}00654          \textcolor{keywordflow}{do} j=1, i}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00655}00655             t = rs(j)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00656}00656             \textcolor{keyword}{call }daxpy(n, t, work0(1,j), 1, uu,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00657}00657 \textcolor{keywordflow}{         end do}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00658}00658 \textcolor{comment}{!        DO NOT restart outer loop EVEN when necessary (that is crucial}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00659}00659 \textcolor{comment}{!        for this implementation of GMRESR):  NEVER goto 10 !  }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00660}00660 \textcolor{comment}{!     if (ro .gt. eps .and. its .lt. niter) goto 10}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00661}00661 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00662}00662 \textcolor{comment}{!     Finally, reproduce vector cc as cc = A*uu = work0*hh1*rs:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00663}00663 \textcolor{comment}{!     rs := hh1(1:i1,1:i) * rs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00664}00664       coeff = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00665}00665       coef1 = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00666}00666       \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'N'},i1,i,coeff,hh1,maxd1,rs,1,coef1,rs1,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00667}00667 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00668}00668 \textcolor{comment}{!     now multiply Krylov basis vectors work0 by rs:}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00669}00669 \textcolor{comment}{!     cc := work0*rs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00670}00670       \textcolor{keyword}{call }dscal(n,coef1,cc,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00671}00671       \textcolor{keywordflow}{do} j=1, i1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00672}00672          t = rs1(j)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00673}00673          \textcolor{keyword}{call }daxpy(n, t, work0(1,j), 1, cc,1)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00674}00674 \textcolor{keywordflow}{      end do}        }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00675}00675 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00676}00676       niter=its}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00677}00677       eps=ro }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00678}00678       \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00679}00679 \textcolor{comment}{!-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ end of gmres0 -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00680}00680       \textcolor{keyword}{end}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00681}00681 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00682}00682 \textcolor{comment}{!     jacobi\_diis\_solver\_external}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00683}00683 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00684}00684 \textcolor{comment}{!     WARNING: code duplication is bad, but here it makes a very specific sense.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00685}00685 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00686}00686 \textcolor{comment}{!     in ddLPB, we are solving a linear system with Jacobi DIIS also to apply the}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00687}00687 \textcolor{comment}{!     preconditioner. As calling a solver recursively is a terrible idea, we}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00688}00688 \textcolor{comment}{!     create a copy of jacobi\_diis that }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00689}00689 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00690}00690 \textcolor{comment}{!     -\/ takes as an input the size of the system to be solved (no hardcoded dependence}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00691}00691 \textcolor{comment}{!       on nsph)}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00692}00692 \textcolor{comment}{!     -\/ uses copies of the norm subroutine, so that it can also be called with }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00693}00693 \textcolor{comment}{!       a user-\/given size for arrays}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00694}00694 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00695}00695 \textcolor{keyword}{subroutine }jacobi\_diis\_external(params, constants, workspace, n, tol, rhs, x, n\_iter, \&}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00696}00696           \& x\_rel\_diff, matvec, dm1vec, norm\_func, info)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00697}00697       \textcolor{keywordtype}{type}(ddx\_params\_type),    \textcolor{keywordtype}{intent(in)}    :: params}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00698}00698       \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)}    :: constants}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00699}00699       \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00700}00700       \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00701}00701       \textcolor{keywordtype}{integer},                  \textcolor{keywordtype}{intent(in)}    :: n}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00702}00702 \textcolor{keywordtype}{      real}(dp),                 \textcolor{keywordtype}{intent(in)}    :: tol}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00703}00703 \textcolor{keywordtype}{      real}(dp),  \textcolor{keywordtype}{dimension(n)},  \textcolor{keywordtype}{intent(in)}    :: rhs}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00704}00704       \textcolor{comment}{! Outputs}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00705}00705 \textcolor{keywordtype}{      real}(dp),  \textcolor{keywordtype}{dimension(n)},  \textcolor{keywordtype}{intent(inout)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00706}00706       \textcolor{keywordtype}{integer},                  \textcolor{keywordtype}{intent(inout)} :: n\_iter, info}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00707}00707 \textcolor{keywordtype}{      real}(dp), \textcolor{keywordtype}{intent(out)} :: x\_rel\_diff(n\_iter)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00708}00708 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00709}00709       \textcolor{keywordtype}{external}                                :: matvec, dm1vec}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00710}00710       \textcolor{keywordtype}{procedure}(\mbox{\hyperlink{interfaceddx__solvers_1_1norm__interface}{norm\_interface}})               :: norm\_func}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00711}00711       \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00712}00712       \textcolor{keywordtype}{integer}  :: it, nmat, istatus, lenb, nsph\_u}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00713}00713 \textcolor{keywordtype}{      real}(dp) :: diff, norm, rel\_diff = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00714}00714       \textcolor{keywordtype}{logical}  :: dodiis}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00715}00715 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00716}00716 \textcolor{keywordtype}{      real}(dp), \textcolor{keywordtype}{allocatable} :: x\_new(:), y(:), x\_diis(:,:), e\_diis(:,:), bmat(:,:)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00717}00717 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00718}00718 \textcolor{comment}{!-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00719}00719 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00720}00720 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00721}00721 \textcolor{comment}{!     DIIS extrapolation flag}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00722}00722       dodiis = (params\%jacobi\_ndiis.gt.0)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00723}00723 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00724}00724 \textcolor{comment}{!     extrapolation required}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00725}00725       \textcolor{keywordflow}{if} (dodiis) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00726}00726 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00727}00727 \textcolor{comment}{!       allocate workspaces}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00728}00728         lenb = params \% jacobi\_ndiis + 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00729}00729         \textcolor{keyword}{allocate}( x\_diis(n,params \% jacobi\_ndiis), e\_diis(n,params \% jacobi\_ndiis), bmat(lenb,lenb) , stat=istatus )}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00730}00730         \textcolor{keywordflow}{if} (istatus .ne. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00731}00731           \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{' jacobi\_diis: [1] failed allocation (diis)'}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00732}00732           stop}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00733}00733 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00734}00734 \textcolor{comment}{!        }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00735}00735 \textcolor{comment}{!       initialize the number of points for diis to one.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00736}00736 \textcolor{comment}{!       note that nmat is updated by diis.}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00737}00737         nmat = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00738}00738 \textcolor{comment}{!        }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00739}00739 \textcolor{keywordflow}{      endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00740}00740 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00741}00741 \textcolor{comment}{!     allocate workspaces}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00742}00742       \textcolor{keyword}{allocate}( x\_new(n), y(n) , stat=istatus )}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00743}00743       \textcolor{keywordflow}{if} (istatus .ne. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00744}00744         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{' jacobi\_diis: [2] failed allocation (scratch)'} }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00745}00745         stop}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00746}00746 \textcolor{keywordflow}{      endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00747}00747 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00748}00748 \textcolor{comment}{!     Jacobi iterations}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00749}00749 \textcolor{comment}{!     =================e}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00750}00750       \textcolor{keywordflow}{do} it = 1, n\_iter}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00751}00751 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00752}00752 \textcolor{comment}{!       y = rhs -\/ O x}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00753}00753         \textcolor{keyword}{call }matvec(params, constants, workspace, x, y )}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00754}00754         y = rhs -\/ y}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00755}00755 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00756}00756 \textcolor{comment}{!       x\_new = D\string^-\/1 y}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00757}00757         \textcolor{keyword}{call }dm1vec(params, constants, workspace, y, x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00758}00758 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00759}00759 \textcolor{comment}{!       DIIS extrapolation}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00760}00760 \textcolor{comment}{!       ==================}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00761}00761         \textcolor{keywordflow}{if} (dodiis) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00762}00762 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00763}00763           x\_diis(:,nmat) = x\_new}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00764}00764           e\_diis(:,nmat) = x\_new -\/ x}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00765}00765 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00766}00766           \textcolor{keyword}{call }diis(n,nmat,params \% jacobi\_ndiis,x\_diis,e\_diis,bmat,x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00767}00767 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00768}00768 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00769}00769 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00770}00770 \textcolor{comment}{!       increment}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00771}00771         x = x\_new -\/ x}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00772}00772 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00773}00773 \textcolor{comment}{!       warning: in the following, we use a quick and dirty hack to pass }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00774}00774 \textcolor{comment}{!       to the norm function arrays double the size than in non ddlpb calculations}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00775}00775 \textcolor{comment}{!       by defining a fake number of spheres with is n/nbasis (i.e., 2*nsph in }}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00776}00776 \textcolor{comment}{!       ddlpb).}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00777}00777 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00778}00778         nsph\_u = n/constants \% nbasis}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00779}00779         diff = norm\_func(params \% lmax, constants \% nbasis, nsph\_u, x)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00780}00780         norm = norm\_func(params \% lmax, constants \% nbasis, nsph\_u, x\_new)}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00781}00781         \textcolor{comment}{! compute rel\_diff using the rule 0/0 = 0}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00782}00782         \textcolor{keywordflow}{if} (diff.eq.zero .and. norm.eq.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00783}00783             rel\_diff = zero}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00784}00784         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00785}00785             rel\_diff = diff / norm}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00786}00786 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00787}00787 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00788}00788         x\_rel\_diff(it) = rel\_diff}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00789}00789 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00790}00790 \textcolor{comment}{!       update}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00791}00791         x = x\_new}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00792}00792 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00793}00793 \textcolor{comment}{!       EXIT Jacobi loop here}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00794}00794 \textcolor{comment}{!       =====================}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00795}00795         \textcolor{keywordflow}{if} (rel\_diff .le. tol) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00796}00796             info = 0}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00797}00797             n\_iter = it}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00798}00798             \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00799}00799 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00800}00800 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00801}00801 \textcolor{keywordflow}{      enddo}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00802}00802 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00803}00803 \textcolor{comment}{!     something went wrong...}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00804}00804       info = 1}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00805}00805 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00806}00806       \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00807}00807 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00808}00808 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00809}00809 \textcolor{keyword}{endsubroutine }jacobi\_diis\_external}
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00810}00810 }
\DoxyCodeLine{\Hypertarget{ddx__solvers_8f90_source_l00811}00811 \textcolor{keyword}{end module }\mbox{\hyperlink{namespaceddx__solvers}{ddx\_solvers}}}

\end{DoxyCode}
