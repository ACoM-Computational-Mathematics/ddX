\hypertarget{ddx__operators_8f90_source}{}\doxysection{ddx\+\_\+operators.\+f90}
\label{ddx__operators_8f90_source}\index{src/ddx\_operators.f90@{src/ddx\_operators.f90}}
\mbox{\hyperlink{ddx__operators_8f90}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00011}00011 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00013}\mbox{\hyperlink{namespaceddx__operators}{00013}} \textcolor{keyword}{module} \mbox{\hyperlink{namespaceddx__operators}{ddx\_operators}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00014}00014 \textcolor{comment}{! Get the solver-\/module}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00015}00015 \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__solvers}{ddx\_solvers}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00016}00016 \textcolor{comment}{! Get lpb core-\/module}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00017}00017 \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__lpb__core}{ddx\_lpb\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00018}00018 \textcolor{comment}{! Get gradient module}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00019}00019 \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__gradients}{ddx\_gradients}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00020}00020 \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00021}00021 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00022}00022 \textcolor{keyword}{contains}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00023}00023 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00025}\mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{00025}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{lx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00026}00026     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00027}00027     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00028}00028     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00029}00029     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00030}00030 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00031}00031     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00032}00032     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00033}00033     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00034}00034 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00035}00035     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00036}00036     \textcolor{keywordtype}{integer} :: isph, jsph, ij, l, ind, iproc}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00037}00037 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00038}00038     \textcolor{comment}{!! Initialize}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00039}00039     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00040}00040 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00041}00041 \textcolor{comment}{!   incore code:}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00042}00042 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00043}00043     \textcolor{keywordflow}{if} (params \% matvecmem .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00044}00044         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00045}00045         \textcolor{comment}{!\$omp private(isph,ij,jsph) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00046}00046         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00047}00047             \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph + 1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00048}00048                 jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00049}00049                 \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'n'}, constants \% nbasis, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00050}00050                     \& constants \% l(:,:,ij), constants \% nbasis, x(:,jsph), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00051}00051                     \& one, y(:,isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00052}00052 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00053}00053 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00054}00054     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00055}00055         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00056}00056         \textcolor{comment}{!\$omp private(isph,iproc) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00057}00057         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00058}00058             iproc = omp\_get\_thread\_num() + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00059}00059             \textcolor{comment}{! Compute NEGATIVE action of off-\/digonal blocks}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00060}00060             \textcolor{keyword}{call }calcv(params, constants, isph, workspace \% tmp\_pot(:, iproc), x, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00061}00061                 \& workspace \% tmp\_work(:, iproc))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00062}00062             \textcolor{keyword}{call }ddintegrate(1, constants \% nbasis, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00063}00063                 \& constants \% vwgrid, constants \% vgrid\_nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00064}00064                 \& workspace \% tmp\_pot(:, iproc), y(:, isph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00065}00065             \textcolor{comment}{! now, fix the sign.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00066}00066             y(:, isph) = -\/ y(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00067}00067 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00068}00068 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00069}00069 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00070}00070 \textcolor{comment}{!   if required, add the diagonal.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00071}00071 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00072}00072     \textcolor{keywordflow}{if} (constants \% dodiag) \textcolor{keywordflow}{then} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00073}00073         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00074}00074             \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00075}00075                 ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00076}00076                 y(ind-\/l:ind+l, isph) = y(ind-\/l:ind+l, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00077}00077                      x(ind-\/l:ind+l, isph) / (constants \% vscales(ind)**2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00078}00078 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00079}00079 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00080}00080 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00081}00081 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{lx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00082}00082 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00084}\mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{00084}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{lstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00085}00085     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00086}00086     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00087}00087     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00088}00088     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00089}00089 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00090}00090     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00091}00091     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00092}00092     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00093}00093 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00094}00094     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00095}00095     \textcolor{keywordtype}{integer} :: isph, jsph, ij, indmat, igrid, l, ind, iproc}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00096}00096     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00097}00097     \textcolor{keywordflow}{if} (params \% matvecmem .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00098}00098         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00099}00099         \textcolor{comment}{!\$omp private(isph,ij,jsph,indmat) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00100}00100         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00101}00101             \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph + 1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00102}00102                 jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00103}00103                 indmat = constants \% itrnl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00104}00104                 \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'t'}, constants \% nbasis, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00105}00105                     \& constants \% l(:,:,indmat), constants \% nbasis, x(:,jsph), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00106}00106                     \& one, y(:,isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00107}00107 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00108}00108 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00109}00109     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00110}00110         \textcolor{comment}{! Expand x over spherical harmonics}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00111}00111         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00112}00112         \textcolor{comment}{!\$omp private(isph,igrid) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00113}00113         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00114}00114             \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00115}00115                 workspace \% tmp\_grid(igrid, isph) = dot\_product(x(:, isph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00116}00116                     \& constants \% vgrid(:constants \% nbasis, igrid))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00117}00117 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00118}00118 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00119}00119         \textcolor{comment}{! Compute (negative) action}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00120}00120         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00121}00121         \textcolor{comment}{!\$omp private(isph,iproc) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00122}00122         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00123}00123             iproc = omp\_get\_thread\_num() + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00124}00124             \textcolor{keyword}{call }adjrhs(params, constants, isph, workspace \% tmp\_grid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00125}00125                 \& y(:, isph), workspace \% tmp\_work(:, iproc))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00126}00126     }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00127}00127             \textcolor{comment}{! fix the sign}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00128}00128             y(:, isph) = -\/ y(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00129}00129 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00130}00130 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00131}00131     \textcolor{keywordflow}{if} (constants \% dodiag) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00132}00132     \textcolor{comment}{! Loop over harmonics}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00133}00133         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00134}00134             \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00135}00135                 ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00136}00136                 y(ind-\/l:ind+l, isph) = y(ind-\/l:ind+l, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00137}00137                     \& x(ind-\/l:ind+l, isph) / (constants \% vscales(ind)**2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00138}00138 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00139}00139 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00140}00140 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00141}00141 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{lstarx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00142}00142 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00146}\mbox{\hyperlink{namespaceddx__operators_a73668d47230f4292955012f9910e4ecc}{00146}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a73668d47230f4292955012f9910e4ecc}{ldm1x}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00147}00147     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00148}00148     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00149}00149     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00150}00150     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00151}00151 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00152}00152     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00153}00153     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00154}00154     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00155}00155 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00156}00156     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00157}00157     \textcolor{keywordtype}{integer} :: isph, l, ind}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00158}00158     \textcolor{comment}{!! Loop over harmonics}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00159}00159     \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00160}00160     \textcolor{comment}{!\$omp private(isph,l,ind) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00161}00161     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00162}00162         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00163}00163             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00164}00164             y(ind-\/l:ind+l, isph) = x(ind-\/l:ind+l, isph) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00165}00165                 \& *(constants \% vscales(ind)**2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00166}00166 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00167}00167 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00168}00168 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a73668d47230f4292955012f9910e4ecc}{ldm1x}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00169}00169 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00171}\mbox{\hyperlink{namespaceddx__operators_a7572750f072f269d318972f1d57cb527}{00171}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a7572750f072f269d318972f1d57cb527}{dx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00172}00172     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00173}00173     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00174}00174     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00175}00175     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00176}00176     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00177}00177 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00178}00178     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00179}00179 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00180}00180     \textcolor{comment}{!! Local parameter}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00181}00181     \textcolor{keywordtype}{integer} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00182}00182     \textcolor{comment}{!! initialize do\_diag}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00183}00183     do\_diag = 0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00184}00184     \textcolor{keywordflow}{if} (constants \% dodiag) do\_diag = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00185}00185     \textcolor{comment}{!! Select implementation}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00186}00186     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00187}00187         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_abd51fb609c2fc3efb3f8095d65492840}{dx\_dense}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00188}00188     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00189}00189         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a1373e4a45d1f9adb748f19f543c2f67f}{dx\_fmm}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00190}00190 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00191}00191 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a7572750f072f269d318972f1d57cb527}{dx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00192}00192 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00194}\mbox{\hyperlink{namespaceddx__operators_abd51fb609c2fc3efb3f8095d65492840}{00194}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_abd51fb609c2fc3efb3f8095d65492840}{dx\_dense}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00195}00195     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00196}00196     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00197}00197     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00198}00198     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00199}00199     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00200}00200     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00201}00201 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00202}00202     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00203}00203 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00204}00204     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00205}00205 \textcolor{keywordtype}{    real}(dp) :: c(3), vij(3), sij(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00206}00206 \textcolor{keywordtype}{    real}(dp) :: vvij, tij, tt, f, f1, rho, ctheta, stheta, cphi, sphi}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00207}00207     \textcolor{keywordtype}{integer} :: its, isph, jsph, l, m, ind, lm, istatus}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00208}00208 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{external} :: dnrm2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00209}00209     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00210}00210     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00211}00211         \textcolor{comment}{! compute the "{}potential"{} from the other spheres}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00212}00212         \textcolor{comment}{! at the exposed lebedv points of the i-\/th sphere }}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00213}00213         workspace \% tmp\_grid(:, 1) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00214}00214         \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00215}00215             \textcolor{keywordflow}{if} (constants \% ui(its,isph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00216}00216                 c = params \% csph(:,isph) + params \% rsph(isph)* \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00217}00217                     \& constants \% cgrid(:,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00218}00218                 \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00219}00219                     \textcolor{keywordflow}{if} (jsph.ne.isph) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00220}00220                         \textcolor{comment}{! build the geometrical variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00221}00221                         vij = c -\/ params \% csph(:,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00222}00222                         \textcolor{comment}{!vvij = sqrt(dot\_product(vij,vij))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00223}00223                         vvij = dnrm2(3, vij, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00224}00224                         tij = vvij / params \% rsph(jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00225}00225                         sij = vij/vvij }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00226}00226                         \textcolor{comment}{! build the local basis}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00227}00227                         \textcolor{keyword}{call }ylmbas(sij, rho, ctheta, stheta, cphi, sphi, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00228}00228                             \& params \% lmax, constants \% vscales, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00229}00229                             \& workspace \% tmp\_vylm, workspace \% tmp\_vplm, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00230}00230                             \& workspace \% tmp\_vcos, workspace \% tmp\_vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00231}00231                         \textcolor{comment}{! with all the required stuff, finally compute}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00232}00232                         \textcolor{comment}{! the "{}potential"{} at the point}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00233}00233                         tt = one/tij }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00234}00234                         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00235}00235                             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00236}00236                             f = fourpi*dble(l)/(two*dble(l) + one)*tt}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00237}00237                             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00238}00238                                 workspace \% tmp\_grid(its, 1) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00239}00239                                     \& workspace \% tmp\_grid(its, 1) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00240}00240                                     \& f*x(ind + m,jsph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00241}00241                                     \& workspace \% tmp\_vylm(ind + m, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00242}00242 \textcolor{keywordflow}{                            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00243}00243                             tt = tt/tij}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00244}00244 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00245}00245                     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (do\_diag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00246}00246                         \textcolor{comment}{! add the diagonal contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00247}00247                         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00248}00248                             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00249}00249                             f = (two*dble(l) + one)/fourpi}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00250}00250                             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00251}00251                                 workspace \% tmp\_grid(its, 1) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00252}00252                                     \& workspace \% tmp\_grid(its, 1) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00253}00253                                     \& pt5*x(ind + m,isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00254}00254                                     \& constants \% vgrid(ind + m,its)/f}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00255}00255 \textcolor{keywordflow}{                            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00256}00256 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00257}00257 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00258}00258 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00259}00259                 workspace \% tmp\_grid(its, 1) = constants \% ui(its, isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00260}00260                     \& workspace \% tmp\_grid(its, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00261}00261 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00262}00262 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00263}00263         \textcolor{comment}{! now integrate the potential to get its modal representation}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00264}00264         \textcolor{keyword}{call }ddintegrate(1, constants \% nbasis, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00265}00265             \& constants \% vwgrid, constants \% vgrid\_nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00266}00266             \& workspace \% tmp\_grid, y(:,isph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00267}00267 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00268}00268 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_abd51fb609c2fc3efb3f8095d65492840}{dx\_dense}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00269}00269 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00271}\mbox{\hyperlink{namespaceddx__operators_a1373e4a45d1f9adb748f19f543c2f67f}{00271}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a1373e4a45d1f9adb748f19f543c2f67f}{dx\_fmm}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00272}00272     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00273}00273     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00274}00274     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00275}00275     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00276}00276     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00277}00277     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00278}00278 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00279}00279     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00280}00280 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00281}00281     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00282}00282     \textcolor{keywordtype}{integer} :: isph, inode, l, indl, indl1, m}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00283}00283 \textcolor{keywordtype}{    real}(dp) :: finish\_time, start\_time}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00284}00284     \textcolor{comment}{!! Scale input harmonics at first}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00285}00285     workspace \% tmp\_sph(1, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00286}00286     indl = 2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00287}00287     \textcolor{keywordflow}{do} l = 1, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00288}00288         indl1 = (l+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00289}00289         workspace \% tmp\_sph(indl:indl1, :) = l * x(indl:indl1, :)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00290}00290         indl = indl1 + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00291}00291 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00292}00292     \textcolor{comment}{! Load input harmonics into tree data}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00293}00293     \textcolor{keywordflow}{if}(params \% lmax .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00294}00294         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00295}00295             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00296}00296             workspace \% tmp\_node\_m(1:constants \% nbasis, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00297}00297                 \& workspace \% tmp\_sph(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00298}00298             workspace \% tmp\_node\_m(constants \% nbasis+1:, inode) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00299}00299 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00300}00300     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00301}00301         indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00302}00302         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00303}00303             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00304}00304             workspace \% tmp\_node\_m(:, inode) = workspace \% tmp\_sph(:indl, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00305}00305 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00306}00306 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00307}00307     \textcolor{comment}{! Do FMM operations}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00308}00308     \textcolor{keyword}{call }tree\_m2m\_rotation(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00309}00309     \textcolor{keyword}{call }tree\_m2l\_rotation(params, constants, workspace \% tmp\_node\_m, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00310}00310         \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00311}00311     \textcolor{keyword}{call }tree\_l2l\_rotation(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00312}00312     \textcolor{keyword}{call }tree\_l2p(params, constants, one, workspace \% tmp\_node\_l, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00313}00313         \& workspace \% tmp\_grid, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00314}00314     \textcolor{keyword}{call }tree\_m2p(params, constants, params \% lmax, one, workspace \% tmp\_sph, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00315}00315         \& workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00316}00316     \textcolor{comment}{! Apply diagonal contribution if needed}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00317}00317     \textcolor{keywordflow}{if}(do\_diag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00318}00318         \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, params \% nsph, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00319}00319             \& constants \% nbasis, -\/pt5, constants \% vgrid2, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00320}00320             \& constants \% vgrid\_nbasis, x, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00321}00321             \& workspace \% tmp\_grid, params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00322}00322 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00323}00323     \textcolor{comment}{! Multiply by characteristic function}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00324}00324     workspace \% tmp\_grid = workspace \% tmp\_grid * constants \% ui}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00325}00325     \textcolor{comment}{! now integrate the potential to get its modal representation}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00326}00326     \textcolor{comment}{! output y is overwritten here}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00327}00327     \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'N'}, \textcolor{stringliteral}{'N'}, constants \% nbasis, params \% nsph, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00328}00328         \& one, constants \% vwgrid, constants \% vgrid\_nbasis, workspace \% tmp\_grid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00329}00329         \& params \% ngrid, zero, y, constants \% nbasis)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00330}00330 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a1373e4a45d1f9adb748f19f543c2f67f}{dx\_fmm}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00331}00331 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00333}\mbox{\hyperlink{namespaceddx__operators_a4763fc6509b475a090451feb661a92ea}{00333}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a4763fc6509b475a090451feb661a92ea}{dstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00334}00334     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00335}00335     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00336}00336     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00337}00337     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00338}00338 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00339}00339     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00340}00340     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00341}00341     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00342}00342 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00343}00343     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00344}00344     \textcolor{keywordtype}{integer} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00345}00345     \textcolor{comment}{!! initialize do\_diag}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00346}00346     do\_diag = 0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00347}00347     \textcolor{keywordflow}{if} (constants \% dodiag) do\_diag = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00348}00348     \textcolor{comment}{!! Select implementation}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00349}00349     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00350}00350         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a5e24847b3de8dd57e855f293eeee9d18}{dstarx\_dense}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00351}00351     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00352}00352         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_aa69a13344481ef2032c3eb2c46e847b3}{dstarx\_fmm}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00353}00353 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00354}00354 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a4763fc6509b475a090451feb661a92ea}{dstarx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00355}00355 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00357}\mbox{\hyperlink{namespaceddx__operators_a5e24847b3de8dd57e855f293eeee9d18}{00357}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a5e24847b3de8dd57e855f293eeee9d18}{dstarx\_dense}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00358}00358     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00359}00359     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00360}00360     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00361}00361     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00362}00362     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00363}00363 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00364}00364     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00365}00365     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00366}00366     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00367}00367 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00368}00368     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00369}00369 \textcolor{keywordtype}{    real}(dp) :: c(3), vji(3), sji(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00370}00370 \textcolor{keywordtype}{    real}(dp) :: vvji, tji, fourpi, tt, f, f1, rho, ctheta, stheta, cphi, sphi}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00371}00371     \textcolor{keywordtype}{integer} :: its, isph, jsph, l, m, ind, lm, istatus}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00372}00372 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{external} :: dnrm2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00373}00373     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00374}00374     \textcolor{comment}{! this loop is easily parallelizable}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00375}00375     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00376}00376         \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00377}00377             \textcolor{keywordflow}{if} (jsph.ne.isph) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00378}00378                 \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00379}00379                     \textcolor{keywordflow}{if} (constants \% ui(its,jsph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00380}00380                         \textcolor{comment}{! build the geometrical variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00381}00381                         vji = params \% csph(:,jsph) + params \% rsph(jsph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00382}00382                             \& constants \% cgrid(:,its) -\/ params \% csph(:,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00383}00383                         \textcolor{comment}{!vvji = sqrt(dot\_product(vji,vji))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00384}00384                         vvji = dnrm2(3, vji, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00385}00385                         tji = vvji/params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00386}00386                         sji = vji/vvji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00387}00387                         \textcolor{comment}{! build the local basis}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00388}00388                         \textcolor{keyword}{call }ylmbas(sji, rho, ctheta, stheta, cphi, sphi, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00389}00389                             \& params \% lmax, constants \% vscales, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00390}00390                             \& workspace \% tmp\_vylm, workspace \% tmp\_vplm, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00391}00391                             \& workspace \% tmp\_vcos, workspace \% tmp\_vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00392}00392                         tt = constants \% ui(its,jsph) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00393}00393                             \& *dot\_product(constants \% vwgrid(:constants \% nbasis, its), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00394}00394                             \& x(:,jsph))/tji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00395}00395                         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00396}00396                             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00397}00397                             f = dble(l)*tt/ constants \% vscales(ind)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00398}00398                             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00399}00399                                 y(ind+m,isph) = y(ind+m,isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00400}00400                                     \& f*workspace \% tmp\_vylm(ind+m, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00401}00401 \textcolor{keywordflow}{                            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00402}00402                             tt = tt/tji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00403}00403 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00404}00404 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00405}00405 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00406}00406             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (do\_diag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00407}00407                 \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00408}00408                     f = pt5*constants \% ui(its,jsph) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00409}00409                         \& *dot\_product(constants \% vwgrid(:constants \% nbasis, its), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00410}00410                         \& x(:,jsph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00411}00411                     \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00412}00412                         ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00413}00413                         y(ind-\/l:ind+l,isph) = y(ind-\/l:ind+l,isph) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00414}00414                             \& f*constants \% vgrid(ind-\/l:ind+l,its)/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00415}00415                             \& constants \% vscales(ind)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00416}00416 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00417}00417 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00418}00418 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00419}00419 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00420}00420 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00421}00421 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a5e24847b3de8dd57e855f293eeee9d18}{dstarx\_dense}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00422}00422 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00424}\mbox{\hyperlink{namespaceddx__operators_aa69a13344481ef2032c3eb2c46e847b3}{00424}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_aa69a13344481ef2032c3eb2c46e847b3}{dstarx\_fmm}}(params, constants, workspace, do\_diag, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00425}00425     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00426}00426     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00427}00427     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00428}00428     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00429}00429     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: do\_diag}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00430}00430 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00431}00431     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00432}00432     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00433}00433     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00434}00434 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00435}00435     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00436}00436     \textcolor{keywordtype}{integer} :: isph, inode, l, indl, indl1, m}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00437}00437 \textcolor{keywordtype}{    real}(dp) :: finish\_time, start\_time}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00438}00438     \textcolor{comment}{! Adjoint integration}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00439}00439     \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, params \% nsph, constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00440}00440         \& one, constants \% vwgrid, constants \% vgrid\_nbasis, x, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00441}00441         \& constants \% nbasis, zero, workspace \% tmp\_grid, params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00442}00442     \textcolor{comment}{! Multiply by characteristic function}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00443}00443     workspace \% tmp\_grid = workspace \% tmp\_grid * constants \% ui}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00444}00444     \textcolor{comment}{! Do FMM operations adjointly}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00445}00445     \textcolor{keyword}{call }tree\_m2p\_adj(params, constants, params \% lmax, one, workspace \% tmp\_grid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00446}00446         \& zero, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00447}00447     \textcolor{keyword}{call }tree\_l2p\_adj(params, constants, one, workspace \% tmp\_grid, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00448}00448         \& workspace \% tmp\_node\_l, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00449}00449     \textcolor{keyword}{call }tree\_l2l\_rotation\_adj(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00450}00450     \textcolor{keyword}{call }tree\_m2l\_rotation\_adj(params, constants, workspace \% tmp\_node\_l, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00451}00451         \& workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00452}00452     \textcolor{keyword}{call }tree\_m2m\_rotation\_adj(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00453}00453     \textcolor{comment}{! Adjointly move tree multipole harmonics into output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00454}00454     \textcolor{keywordflow}{if}(params \% lmax .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00455}00455         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00456}00456             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00457}00457             y(:, isph) = y(:, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00458}00458                 \& workspace \% tmp\_node\_m(1:constants \% nbasis, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00459}00459 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00460}00460     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00461}00461         indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00462}00462         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00463}00463             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00464}00464             y(1:indl, isph) = y(1:indl, isph) + workspace \% tmp\_node\_m(:, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00465}00465 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00466}00466 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00467}00467     \textcolor{comment}{! Scale output harmonics at last}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00468}00468     y(1, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00469}00469     indl = 2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00470}00470     \textcolor{keywordflow}{do} l = 1, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00471}00471         indl1 = (l+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00472}00472         y(indl:indl1, :) = l * y(indl:indl1, :)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00473}00473         indl = indl1 + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00474}00474 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00475}00475     \textcolor{comment}{! Apply diagonal contribution if needed}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00476}00476     \textcolor{keywordflow}{if}(do\_diag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00477}00477         \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'N'}, \textcolor{stringliteral}{'N'}, constants \% nbasis, params \% nsph, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00478}00478             \& params \% ngrid, -\/pt5, constants \% vgrid2, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00479}00479             \& constants \% vgrid\_nbasis, workspace \% tmp\_grid, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00480}00480             \& one, y, constants \% nbasis)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00481}00481 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00482}00482 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_aa69a13344481ef2032c3eb2c46e847b3}{dstarx\_fmm}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00483}00483 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00488}\mbox{\hyperlink{namespaceddx__operators_ace05a424bd4e0a226b635723aba4389c}{00488}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_ace05a424bd4e0a226b635723aba4389c}{repsx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00489}00489     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00490}00490     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00491}00491     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00492}00492     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00493}00493 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00494}00494     \textcolor{comment}{!! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00495}00495     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00496}00496     \textcolor{comment}{!! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00497}00497 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00498}00498     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00499}00499 \textcolor{keywordtype}{    real}(dp) :: fac}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00500}00500     \textcolor{comment}{!! Output `y` is cleaned here}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00501}00501     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a7572750f072f269d318972f1d57cb527}{dx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00502}00502     y = -\/ y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00503}00503     \textcolor{keywordflow}{if} (constants \% dodiag) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00504}00504     \textcolor{comment}{! Apply diagonal}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00505}00505         fac = twopi * (params \% eps + one) / (params \% eps -\/ one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00506}00506         y = fac*x + y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00507}00507 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00508}00508 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_ace05a424bd4e0a226b635723aba4389c}{repsx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00509}00509 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00514}\mbox{\hyperlink{namespaceddx__operators_a0670b7a7bd830dd57ee0dc2dbcb80b1a}{00514}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a0670b7a7bd830dd57ee0dc2dbcb80b1a}{repsstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00515}00515     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00516}00516     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00517}00517     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00518}00518     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00519}00519 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00520}00520     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00521}00521     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00522}00522     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00523}00523 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00524}00524     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00525}00525 \textcolor{keywordtype}{    real}(dp) :: fac}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00526}00526     \textcolor{comment}{! Output `y` is cleaned here}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00527}00527     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a4763fc6509b475a090451feb661a92ea}{dstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00528}00528     y = -\/ y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00529}00529     \textcolor{comment}{! Apply diagonal}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00530}00530     \textcolor{keywordflow}{if} (constants \% dodiag) \textcolor{keywordflow}{then} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00531}00531         fac = twopi * (params \% eps + one) / (params \% eps -\/ one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00532}00532         y = fac*x + y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00533}00533 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00534}00534 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a0670b7a7bd830dd57ee0dc2dbcb80b1a}{repsstarx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00535}00535 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00543}\mbox{\hyperlink{namespaceddx__operators_ad322bb8c91dfbed143be683333be9430}{00543}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_ad322bb8c91dfbed143be683333be9430}{rinfx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00544}00544     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00545}00545     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00546}00546     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00547}00547     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00548}00548 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00549}00549     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00550}00550     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00551}00551     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00552}00552 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00553}00553     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00554}00554 \textcolor{keywordtype}{    real}(dp) :: fac}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00555}00555     \textcolor{comment}{!! note do\_diag hardcoded to 1.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00556}00556     \textcolor{comment}{!! Select implementation}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00557}00557     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00558}00558         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_abd51fb609c2fc3efb3f8095d65492840}{dx\_dense}}(params, constants, workspace, 1, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00559}00559     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00560}00560         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a1373e4a45d1f9adb748f19f543c2f67f}{dx\_fmm}}(params, constants, workspace, 1, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00561}00561 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00562}00562     \textcolor{comment}{! Apply diagonal}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00563}00563     y = twopi*x -\/ y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00564}00564 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_ad322bb8c91dfbed143be683333be9430}{rinfx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00565}00565 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00573}\mbox{\hyperlink{namespaceddx__operators_a9c02c21086e56924eec13cc33a96eebb}{00573}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a9c02c21086e56924eec13cc33a96eebb}{rstarinfx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00574}00574     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00575}00575     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00576}00576     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00577}00577     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00578}00578 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00579}00579     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00580}00580     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00581}00581     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00582}00582 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00583}00583     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00584}00584 \textcolor{keywordtype}{    real}(dp) :: fac}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00585}00585     \textcolor{comment}{! Output `y` is cleaned here}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00586}00586     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a4763fc6509b475a090451feb661a92ea}{dstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00587}00587     \textcolor{comment}{! Apply diagonal}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00588}00588     y = twopi*x -\/ y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00589}00589 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a9c02c21086e56924eec13cc33a96eebb}{rstarinfx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00590}00590 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00592}\mbox{\hyperlink{namespaceddx__operators_a35303800b0d9c1749358f5e90bcbd52f}{00592}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a35303800b0d9c1749358f5e90bcbd52f}{prec\_repsx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00593}00593     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00594}00594     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00595}00595     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00596}00596     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00597}00597 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00598}00598     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00599}00599     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00600}00600     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00601}00601 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00602}00602     \textcolor{keywordtype}{integer} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00603}00603     \textcolor{comment}{! simply do a matrix-\/vector product with the transposed preconditioner }}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00604}00604     \textcolor{comment}{!\$omp parallel do default(shared) schedule(static,1) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00605}00605     \textcolor{comment}{!\$omp private(isph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00606}00606     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00607}00607         \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'N'}, \textcolor{stringliteral}{'N'}, constants \% nbasis, 1, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00608}00608             \& constants \% rx\_prc(:, :, isph), constants \% nbasis, x(:, isph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00609}00609             \& constants \% nbasis, zero, y(:, isph), constants \% nbasis)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00610}00610 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00611}00611 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a35303800b0d9c1749358f5e90bcbd52f}{prec\_repsx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00612}00612 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00614}\mbox{\hyperlink{namespaceddx__operators_a682ecf4161b6846177c71db55924c586}{00614}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a682ecf4161b6846177c71db55924c586}{prec\_repsstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00615}00615     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00616}00616     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00617}00617     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00618}00618     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00619}00619 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00620}00620     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00621}00621     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00622}00622     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00623}00623 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00624}00624     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00625}00625     \textcolor{keywordtype}{integer} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00626}00626     \textcolor{comment}{! simply do a matrix-\/vector product with the transposed preconditioner }}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00627}00627     \textcolor{comment}{!\$omp parallel do default(shared) schedule(static,1) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00628}00628     \textcolor{comment}{!\$omp private(isph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00629}00629     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00630}00630         \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, constants \% nbasis, 1, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00631}00631             \& constants \% rx\_prc(:, :, isph), constants \% nbasis, x(:, isph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00632}00632             \& constants \% nbasis, zero, y(:, isph), constants \% nbasis)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00633}00633 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00634}00634 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a682ecf4161b6846177c71db55924c586}{prec\_repsstarx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00635}00635 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00636}00636 \textcolor{keyword}{subroutine }gradr(params, constants, workspace, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00637}00637     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00638}00638     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00639}00639     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00640}00640     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00641}00641 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: g(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00642}00642         \& ygrid(params \% ngrid, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00643}00643     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00644}00644     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00645}00645     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00646}00646 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: fx(3, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00647}00647     \textcolor{comment}{! Check which gradr to execute}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00648}00648     \textcolor{keywordflow}{if} (params \% fmm .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00649}00649         \textcolor{keyword}{call }gradr\_fmm(params, constants, workspace, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00650}00650     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00651}00651         \textcolor{keyword}{call }gradr\_dense(params, constants, workspace, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00652}00652 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00653}00653 \textcolor{keyword}{end subroutine }gradr}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00654}00654 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00655}00655 \textcolor{keyword}{subroutine }gradr\_dense(params, constants, workspace, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00656}00656     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00657}00657     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00658}00658     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00659}00659     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00660}00660 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: g(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00661}00661         \& ygrid(params \% ngrid, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00662}00662     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00663}00663     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00664}00664     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00665}00665 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: fx(3, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00666}00666     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00667}00667     \textcolor{keywordtype}{integer} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00668}00668 \textcolor{keywordtype}{    real}(dp) :: vplm(constants \% nbasis), vcos(params \% lmax+1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00669}00669         \& vsin(params \% lmax+1), basloc(constants \% nbasis), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00670}00670         \& dbsloc(3, constants \% nbasis)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00671}00671     \textcolor{comment}{! Simply cycle over all spheres}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00672}00672     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00673}00673         \textcolor{keyword}{call }gradr\_sph(params, constants, isph, vplm, vcos, vsin, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00674}00674             \& dbsloc, g, ygrid, fx(:, isph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00675}00675 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00676}00676 \textcolor{keyword}{end subroutine }gradr\_dense}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00677}00677 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00678}00678 \textcolor{keyword}{subroutine }gradr\_sph(params, constants, isph, vplm, vcos, vsin, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00679}00679         \& dbsloc, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00680}00680     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00681}00681     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00682}00682     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00683}00683     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00684}00684     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00685}00685 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: g(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00686}00686         \& ygrid(params \% ngrid, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00687}00687     \textcolor{keywordtype}{real(dp)}, \textcolor{keywordtype}{intent(inout)} :: vplm(constants \% nbasis), vcos(params \% lmax+1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00688}00688         \& vsin(params \% lmax+1), basloc(constants \% nbasis), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00689}00689         \& dbsloc(3, constants \% nbasis), fx(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00690}00690     \textcolor{comment}{! various scratch arrays}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00691}00691 \textcolor{keywordtype}{    real}(dp) vik(3), sik(3), vki(3), ski(3), vkj(3), skj(3), vji(3), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00692}00692         \& sji(3), va(3), vb(3), a(3), d(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00693}00693     \textcolor{comment}{! jacobian matrix}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00694}00694 \textcolor{keywordtype}{    real}(dp) sjac(3,3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00695}00695     \textcolor{comment}{! indexes}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00696}00696     \textcolor{keywordtype}{integer} its, ik, ksph, l, m, ind, jsph, icomp, jcomp}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00697}00697     \textcolor{comment}{! various scalar quantities}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00698}00698 \textcolor{keywordtype}{    real}(dp) cx, cy, cz, vvki, tki, gg, fl, fac, vvkj, tkj}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00699}00699 \textcolor{keywordtype}{    real}(dp) tt, fcl, dij, fjj, gi, fii, vvji, tji, qji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00700}00700 \textcolor{keywordtype}{    real}(dp) b, vvik, tik, qik, tlow, thigh, duj}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00701}00701 \textcolor{keywordtype}{    real}(dp) :: rho, ctheta, stheta, cphi, sphi}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00702}00702 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{external} :: dnrm2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00703}00703 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00704}00704     tlow  = one -\/ pt5*(one -\/ params \% se)*params \% eta}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00705}00705     thigh = one + pt5*(one + params \% se)*params \% eta}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00706}00706 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00707}00707     \textcolor{comment}{! first set of contributions:}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00708}00708     \textcolor{comment}{! diagonal block, kc and part of kb}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00709}00709 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00710}00710     fx = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00711}00711     \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00712}00712         \textcolor{comment}{! sum over ksph in neighbors of isph}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00713}00713         \textcolor{keywordflow}{do} ik = constants \% inl(isph), constants \% inl(isph+1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00714}00714             ksph = constants \% nl(ik)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00715}00715             \textcolor{comment}{! build geometrical quantities}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00716}00716             cx = params \% csph(1,ksph) + params \% rsph(ksph)*constants \% cgrid(1,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00717}00717             cy = params \% csph(2,ksph) + params \% rsph(ksph)*constants \% cgrid(2,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00718}00718             cz = params \% csph(3,ksph) + params \% rsph(ksph)*constants \% cgrid(3,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00719}00719             vki(1) = cx -\/ params \% csph(1,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00720}00720             vki(2) = cy -\/ params \% csph(2,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00721}00721             vki(3) = cz -\/ params \% csph(3,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00722}00722             \textcolor{comment}{!vvki = sqrt(vki(1)*vki(1) + vki(2)*vki(2) + \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00723}00723             \textcolor{comment}{!    \& vki(3)*vki(3))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00724}00724             vvki = dnrm2(3, vki, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00725}00725             tki  = vvki/params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00726}00726 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00727}00727             \textcolor{comment}{! contributions involving grad i of uk come from the switching}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00728}00728             \textcolor{comment}{! region.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00729}00729             \textcolor{comment}{! note: ui avoids contributions from points that are in the}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00730}00730             \textcolor{comment}{! switching between isph and ksph but are buried in a third}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00731}00731             \textcolor{comment}{! sphere.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00732}00732             \textcolor{keywordflow}{if} ((tki.gt.tlow).and.(tki.lt.thigh) .and. \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00733}00733                 \& constants \% ui(its,ksph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00734}00734                 \textcolor{comment}{! other geometrical quantities}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00735}00735                 ski = vki/vvki}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00736}00736 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00737}00737                 \textcolor{comment}{! diagonal block kk contribution, with k in n(i)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00738}00738                 gg = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00739}00739                 \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00740}00740                     ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00741}00741                     fl = dble(l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00742}00742                     fac = twopi/(two*fl + one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00743}00743                     \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00744}00744                         \textcolor{comment}{!! DEBUG comment}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00745}00745                         gg = gg + fac*constants \% vgrid(ind+m,its)*g(ind+m,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00746}00746 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00747}00747 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00748}00748 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00749}00749                 \textcolor{comment}{! kc contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00750}00750                 \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00751}00751                     \textcolor{keywordflow}{if} (jsph.ne.ksph .and. jsph.ne.isph) \textcolor{keywordflow}{then} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00752}00752                         vkj(1) = cx -\/ params \% csph(1,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00753}00753                         vkj(2) = cy -\/ params \% csph(2,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00754}00754                         vkj(3) = cz -\/ params \% csph(3,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00755}00755                         vvkj = sqrt(vkj(1)*vkj(1) + vkj(2)*vkj(2) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00756}00756                             \& vkj(3)*vkj(3))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00757}00757                         vvkj = dnrm2(3, vkj, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00758}00758                         tkj  = vvkj/params \% rsph(jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00759}00759                         skj  = vkj/vvkj}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00760}00760                         \textcolor{keyword}{call }ylmbas(skj, rho, ctheta, stheta, cphi, sphi, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00761}00761                             \& params \% lmax, constants \% vscales, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00762}00762                             \& vplm, vcos, vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00763}00763                         tt = one/tkj}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00764}00764                         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00765}00765                             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00766}00766                             fcl = -\/ fourpi*dble(l)/(two*dble(l)+one)*tt}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00767}00767                             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00768}00768                                 \textcolor{comment}{!! DEBUG comment}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00769}00769                                 gg = gg + fcl*g(ind+m,jsph)*basloc(ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00770}00770 \textcolor{keywordflow}{                            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00771}00771                             tt = tt/tkj}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00772}00772 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00773}00773                         \textcolor{comment}{!call fmm\_m2p(vkj, params \% rsph(jsph), \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00774}00774                         \textcolor{comment}{!    \& params \% lmax, constants \% vscales\_rel, -\/one, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00775}00775                         \textcolor{comment}{!    \& g(:, jsph), one, gg)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00776}00776 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00777}00777 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00778}00778 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00779}00779                 \textcolor{comment}{! part of kb contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00780}00780                 \textcolor{keyword}{call }ylmbas(ski, rho, ctheta, stheta, cphi, sphi, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00781}00781                     \& params \% lmax, constants \% vscales, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00782}00782                     \& vplm, vcos, vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00783}00783                 tt = one/tki}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00784}00784                 \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00785}00785                     ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00786}00786                     fcl = -\/ four*pi*dble(l)/(two*dble(l)+one)*tt}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00787}00787                     \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00788}00788                         \textcolor{comment}{!! DEBUG comment}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00789}00789                         gg = gg + fcl*g(ind+m,isph)*basloc(ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00790}00790 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00791}00791                     tt = tt/tki}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00792}00792 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00793}00793                 \textcolor{comment}{!call fmm\_m2p(vki, params \% rsph(isph), \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00794}00794                 \textcolor{comment}{!    \& params \% lmax, constants \% vscales\_rel, -\/one, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00795}00795                 \textcolor{comment}{!    \& g(:, isph), one, gg)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00796}00796 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00797}00797                 \textcolor{comment}{! common step, product with grad i uj}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00798}00798                 duj = dfsw(tki,params \% se, params \% eta)/params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00799}00799                 fjj = duj*constants \% wgrid(its)*gg*ygrid(its,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00800}00800                 fx(1) = fx(1) -\/ fjj*ski(1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00801}00801                 fx(2) = fx(2) -\/ fjj*ski(2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00802}00802                 fx(3) = fx(3) -\/ fjj*ski(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00803}00803 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00804}00804 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00805}00805 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00806}00806         \textcolor{comment}{! diagonal block ii contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00807}00807         \textcolor{keywordflow}{if} (constants \% ui(its,isph).gt.zero.and.constants \% ui(its,isph).lt.one) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00808}00808             gi = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00809}00809             \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00810}00810                 ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00811}00811                 fl = dble(l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00812}00812                 fac = twopi/(two*fl + one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00813}00813                 \textcolor{keywordflow}{do} m = -\/l, l }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00814}00814                     \textcolor{comment}{!! DEBUG comment}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00815}00815                     gi = gi + fac*constants \% vgrid(ind+m,its)*g(ind+m,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00816}00816                     \textcolor{comment}{!gi = gi + pt5*constants \% vgrid2(ind+m,its)*g(ind+m,isph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00817}00817 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00818}00818 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00819}00819             \textcolor{comment}{!do l = 0, (params \% lmax+1)**2}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00820}00820             \textcolor{comment}{!    gi = gi + constants \% vgrid2(l, its)*g(l, isph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00821}00821             \textcolor{comment}{!end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00822}00822             \textcolor{comment}{!gi = pt5 * gi}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00823}00823             fii = constants \% wgrid(its)*gi*ygrid(its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00824}00824             fx(1) = fx(1) + fii*constants \% zi(1,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00825}00825             fx(2) = fx(2) + fii*constants \% zi(2,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00826}00826             fx(3) = fx(3) + fii*constants \% zi(3,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00827}00827 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00828}00828 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00829}00829 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00830}00830     \textcolor{comment}{! second set of contributions:}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00831}00831     \textcolor{comment}{! part of kb and ka}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00832}00832     \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00833}00833 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00834}00834         \textcolor{comment}{! run over all the spheres except isph }}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00835}00835         \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00836}00836             \textcolor{keywordflow}{if} (constants \% ui(its,jsph).gt.zero .and. jsph.ne.isph) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00837}00837                 \textcolor{comment}{! build geometrical quantities}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00838}00838                 cx = params \% csph(1,jsph) + params \% rsph(jsph)*constants \% cgrid(1,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00839}00839                 cy = params \% csph(2,jsph) + params \% rsph(jsph)*constants \% cgrid(2,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00840}00840                 cz = params \% csph(3,jsph) + params \% rsph(jsph)*constants \% cgrid(3,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00841}00841                 vji(1) = cx -\/ params \% csph(1,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00842}00842                 vji(2) = cy -\/ params \% csph(2,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00843}00843                 vji(3) = cz -\/ params \% csph(3,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00844}00844                 \textcolor{comment}{!vvji = sqrt(vji(1)*vji(1) + vji(2)*vji(2) + \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00845}00845                 \textcolor{comment}{!    \&  vji(3)*vji(3))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00846}00846                 vvji = dnrm2(3, vji, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00847}00847                 tji = vvji/params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00848}00848                 qji = one/vvji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00849}00849                 sji = vji/vvji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00850}00850 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00851}00851                 \textcolor{comment}{! build the jacobian of sji}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00852}00852                 sjac = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00853}00853                 sjac(1,1) = -\/ one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00854}00854                 sjac(2,2) = -\/ one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00855}00855                 sjac(3,3) = -\/ one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00856}00856                 \textcolor{keywordflow}{do} icomp = 1, 3}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00857}00857                     \textcolor{keywordflow}{do} jcomp = 1, 3}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00858}00858                         sjac(icomp,jcomp) = qji*(sjac(icomp,jcomp) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00859}00859                             \& + sji(icomp)*sji(jcomp))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00860}00860 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00861}00861 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00862}00862 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00863}00863                 \textcolor{comment}{! assemble the local basis and its gradient}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00864}00864                 \textcolor{comment}{!call dbasis(sji,basloc,dbsloc,vplm,vcos,vsin)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00865}00865                 \textcolor{keyword}{call }dbasis(params, constants, sji,basloc,dbsloc,vplm,vcos,vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00866}00866 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00867}00867                 \textcolor{comment}{! assemble the contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00868}00868                 a = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00869}00869                 tt = one/(tji)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00870}00870                 \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00871}00871                     ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00872}00872                     fl = dble(l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00873}00873                     fcl = -\/ tt*fourpi*fl/(two*fl + one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00874}00874                     \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00875}00875                         fac = fcl*g(ind+m,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00876}00876                         b = (fl + one)*basloc(ind+m)/(params \% rsph(isph)*tji)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00877}00877 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00878}00878                         \textcolor{comment}{! apply the jacobian to grad y}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00879}00879                         va(1) = sjac(1,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00880}00880                             \& sjac(1,2)*dbsloc(2,ind+m) + sjac(1,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00881}00881                         va(2) = sjac(2,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00882}00882                             \& sjac(2,2)*dbsloc(2,ind+m) + sjac(2,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00883}00883                         va(3) = sjac(3,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00884}00884                             \& sjac(3,2)*dbsloc(2,ind+m) + sjac(3,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00885}00885                         a(1) = a(1) + fac*(sji(1)*b + va(1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00886}00886                         a(2) = a(2) + fac*(sji(2)*b + va(2))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00887}00887                         a(3) = a(3) + fac*(sji(3)*b + va(3))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00888}00888 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00889}00889                     tt = tt/tji}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00890}00890 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00891}00891                 fac = constants \% ui(its,jsph)*constants \% wgrid(its)*ygrid(its,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00892}00892                 fx(1) = fx(1) -\/ fac*a(1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00893}00893                 fx(2) = fx(2) -\/ fac*a(2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00894}00894                 fx(3) = fx(3) -\/ fac*a(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00895}00895 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00896}00896 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00897}00897 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00898}00898 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00899}00899     \textcolor{comment}{! ka contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00900}00900     \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00901}00901         cx = params \% csph(1,isph) + params \% rsph(isph)*constants \% cgrid(1,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00902}00902         cy = params \% csph(2,isph) + params \% rsph(isph)*constants \% cgrid(2,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00903}00903         cz = params \% csph(3,isph) + params \% rsph(isph)*constants \% cgrid(3,its)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00904}00904         a = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00905}00905 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00906}00906         \textcolor{comment}{! iterate on all the spheres except isph}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00907}00907         \textcolor{keywordflow}{do} ksph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00908}00908             \textcolor{keywordflow}{if} (constants \% ui(its,isph).gt.zero .and. ksph.ne.isph) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00909}00909                 \textcolor{comment}{! geometrical stuff}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00910}00910                 vik(1) = cx -\/ params \% csph(1,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00911}00911                 vik(2) = cy -\/ params \% csph(2,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00912}00912                 vik(3) = cz -\/ params \% csph(3,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00913}00913                 \textcolor{comment}{!vvik = sqrt(vik(1)*vik(1) + vik(2)*vik(2) + \& }}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00914}00914                 \textcolor{comment}{!    \& vik(3)*vik(3))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00915}00915                 vvik = dnrm2(3, vik, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00916}00916                 tik = vvik/params \% rsph(ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00917}00917                 qik = one/vvik}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00918}00918                 sik = vik/vvik}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00919}00919 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00920}00920                 \textcolor{comment}{! build the jacobian of sik}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00921}00921                 sjac = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00922}00922                 sjac(1,1) = one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00923}00923                 sjac(2,2) = one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00924}00924                 sjac(3,3) = one}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00925}00925                 \textcolor{keywordflow}{do} icomp = 1, 3}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00926}00926                     \textcolor{keywordflow}{do} jcomp = 1, 3}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00927}00927                     sjac(icomp,jcomp) = qik*(sjac(icomp,jcomp) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00928}00928                         \& -\/ sik(icomp)*sik(jcomp))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00929}00929 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00930}00930 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00931}00931 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00932}00932                 \textcolor{comment}{! if we are in the switching region, recover grad\_i u\_i}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00933}00933                 vb = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00934}00934                 \textcolor{keywordflow}{if} (constants \% ui(its,isph).lt.one) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00935}00935                     vb(1) = constants \% zi(1,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00936}00936                     vb(2) = constants \% zi(2,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00937}00937                     vb(3) = constants \% zi(3,its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00938}00938 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00939}00939 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00940}00940                 \textcolor{comment}{! assemble the local basis and its gradient}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00941}00941                 \textcolor{comment}{!call dbasis(sik,basloc,dbsloc,vplm,vcos,vsin)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00942}00942                 \textcolor{keyword}{call }dbasis(params, constants, sik,basloc,dbsloc,vplm,vcos,vsin)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00943}00943 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00944}00944                 \textcolor{comment}{! assemble the contribution}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00945}00945                 tt = one/(tik)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00946}00946                 \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00947}00947                     ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00948}00948                     fl = dble(l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00949}00949                     fcl = -\/ tt*fourpi*fl/(two*fl + one)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00950}00950                         \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00951}00951                         fac = fcl*g(ind+m,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00952}00952                         fac = -\/ fac*basloc(ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00953}00953                         a(1) = a(1) + fac*vb(1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00954}00954                         a(2) = a(2) + fac*vb(2) }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00955}00955                         a(3) = a(3) + fac*vb(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00956}00956 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00957}00957                         fac = constants \% ui(its,isph)*fcl*g(ind+m,ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00958}00958                         b = -\/ (fl + one)*basloc(ind+m)/(params \% rsph(ksph)*tik)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00959}00959 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00960}00960                         \textcolor{comment}{! apply the jacobian to grad y}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00961}00961                         va(1) = sjac(1,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00962}00962                             \& sjac(1,2)*dbsloc(2,ind+m) + sjac(1,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00963}00963                         va(2) = sjac(2,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00964}00964                             \& sjac(2,2)*dbsloc(2,ind+m) + sjac(2,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00965}00965                         va(3) = sjac(3,1)*dbsloc(1,ind+m) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00966}00966                             \& sjac(3,2)*dbsloc(2,ind+m) + sjac(3,3)*dbsloc(3,ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00967}00967                         a(1) = a(1) + fac*(sik(1)*b + va(1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00968}00968                         a(2) = a(2) + fac*(sik(2)*b + va(2))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00969}00969                         a(3) = a(3) + fac*(sik(3)*b + va(3))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00970}00970 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00971}00971                     tt = tt/tik}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00972}00972 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00973}00973 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00974}00974 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00975}00975         fac = constants \% wgrid(its)*ygrid(its,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00976}00976         fx(1) = fx(1) -\/ fac*a(1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00977}00977         fx(2) = fx(2) -\/ fac*a(2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00978}00978         fx(3) = fx(3) -\/ fac*a(3)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00979}00979 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00980}00980 \textcolor{keyword}{end subroutine }gradr\_sph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00981}00981 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00982}00982 \textcolor{comment}{! Compute PCM portion of forces (2 matvecs)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00983}00983 \textcolor{keyword}{subroutine }gradr\_fmm(params, constants, workspace, g, ygrid, fx)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00984}00984     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00985}00985     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00986}00986     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00987}00987     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00988}00988 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: g(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00989}00989         \& ygrid(params \% ngrid, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00990}00990     \textcolor{comment}{! Temporaries}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00991}00991     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00992}00992     \textcolor{comment}{! Output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00993}00993 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: fx(3, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00994}00994     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00995}00995     \textcolor{keywordtype}{integer} :: i, j, indi, indj, indl, indl1, l, m, isph, igrid, ik, ksph, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00996}00996         \& jsph, jsph\_node}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00997}00997     \textcolor{keywordtype}{real(dp)} :: start, finish, time}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00998}00998     \textcolor{keywordtype}{integer} :: inear, inode, jnode}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l00999}00999 \textcolor{keywordtype}{    real}(dp) :: fac, fl, gg, c(3), vki(3), vvki, tki, gg3(3), tmp1, tmp2, tmp\_gg}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01000}01000 \textcolor{keywordtype}{    real}(dp) :: tlow, thigh}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01001}01001 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(3, 3)} :: zx\_coord\_transform, zy\_coord\_transform}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01002}01002 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{external} :: ddot, dnrm2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01003}01003 \textcolor{keywordtype}{    real}(dp) :: work(params \% lmax+2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01004}01004     \textcolor{comment}{!real(dp) :: l2g(params \% ngrid, params \% nsph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01005}01005     zx\_coord\_transform = 0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01006}01006     zx\_coord\_transform(3, 2) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01007}01007     zx\_coord\_transform(2, 3) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01008}01008     zx\_coord\_transform(1, 1) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01009}01009     zy\_coord\_transform = 0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01010}01010     zy\_coord\_transform(1, 2) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01011}01011     zy\_coord\_transform(2, 1) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01012}01012     zy\_coord\_transform(3, 3) = 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01013}01013     tlow  = one -\/ pt5*(one -\/ params \% se)*params \% eta}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01014}01014     thigh = one + pt5*(one + params \% se)*params \% eta}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01015}01015     fx = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01016}01016     \textcolor{comment}{!! Scale input harmonics at first}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01017}01017     workspace \% tmp\_sph(1, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01018}01018     indl = 2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01019}01019     \textcolor{keywordflow}{do} l = 1, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01020}01020         indl1 = (l+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01021}01021         workspace \% tmp\_sph(indl:indl1, :) = l * g(indl:indl1, :)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01022}01022         indl = indl1 + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01023}01023 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01024}01024     \textcolor{comment}{!! Compute gradient of M2M of tmp\_sph harmonics at the origin and store it}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01025}01025     \textcolor{comment}{!! in tmp\_sph\_grad. tmp\_sph\_grad(:, 1, :), tmp\_sph\_grad(:, 2, :) and}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01026}01026     \textcolor{comment}{!! tmp\_sph\_grad(:, 3, :) correspond to the OX, OY and OZ axes. Variable}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01027}01027     \textcolor{comment}{!! tmp\_sph2 is a temporary workspace here.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01028}01028     \textcolor{keyword}{call }tree\_grad\_m2m(params, constants, workspace \% tmp\_sph, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01029}01029         \& workspace \% tmp\_sph\_grad, workspace \% tmp\_sph2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01030}01030     \textcolor{comment}{!! Adjoint full FMM matvec to get output multipole expansions from input}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01031}01031     \textcolor{comment}{!! external grid points. It is used to compute R\_i\string^B fast as a contraction}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01032}01032     \textcolor{comment}{!! of a gradient stored in tmp\_sph\_grad and a result of adjoint matvec.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01033}01033     \textcolor{comment}{! Adjoint integration from spherical harmonics to grid points is not needed}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01034}01034     \textcolor{comment}{! here as ygrid already contains grid values, we just need to scale it by}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01035}01035     \textcolor{comment}{! weights of grid points}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01036}01036     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01037}01037         workspace \% tmp\_grid(:, isph) = ygrid(:, isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01038}01038             \& constants \% wgrid(:) * constants \% ui(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01039}01039 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01040}01040     \textcolor{comment}{! Adjoint FMM with output tmp\_sph2(:, :) which stores coefficients of}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01041}01041     \textcolor{comment}{! harmonics of degree up to lmax+1}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01042}01042     \textcolor{keyword}{call }tree\_m2p\_adj(params, constants, params \% lmax+1, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01043}01043         \& workspace \% tmp\_grid, zero, workspace \% tmp\_sph2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01044}01044     \textcolor{keyword}{call }tree\_l2p\_adj(params, constants, one, workspace \% tmp\_grid, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01045}01045         \& workspace \% tmp\_node\_l, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01046}01046     \textcolor{keyword}{call }tree\_l2l\_rotation\_adj(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01047}01047     \textcolor{keyword}{call }tree\_m2l\_rotation\_adj(params, constants, workspace \% tmp\_node\_l, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01048}01048         \& workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01049}01049     \textcolor{keyword}{call }tree\_m2m\_rotation\_adj(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01050}01050     \textcolor{comment}{! Properly load adjoint multipole harmonics into tmp\_sph2 that holds}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01051}01051     \textcolor{comment}{! harmonics of a degree up to lmax+1}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01052}01052     \textcolor{keywordflow}{if}(params \% lmax+1 .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01053}01053         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01054}01054             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01055}01055             workspace \% tmp\_sph2(:, isph) = workspace \% tmp\_sph2(:, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01056}01056                 \& workspace \% tmp\_node\_m(1:constants \% grad\_nbasis, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01057}01057 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01058}01058     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01059}01059         indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01060}01060         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01061}01061             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01062}01062             workspace \% tmp\_sph2(1:indl, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01063}01063                 \& workspace \% tmp\_sph2(1:indl, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01064}01064                 \& workspace \% tmp\_node\_m(:, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01065}01065 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01066}01066 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01067}01067     \textcolor{comment}{! Compute second term of R\_i\string^B as a contraction}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01068}01068     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01069}01069         \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'T'}, constants \% grad\_nbasis, 3, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01070}01070             \& workspace \% tmp\_sph\_grad(1, 1, isph), constants \% grad\_nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01071}01071             \& workspace \% tmp\_sph2(1, isph), 1, zero, fx(1, isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01072}01072 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01073}01073     \textcolor{comment}{!! Direct far-\/field FMM matvec to get output local expansions from input}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01074}01074     \textcolor{comment}{!! multipole expansions. It will be used in R\_i\string^A.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01075}01075     \textcolor{comment}{!! As of now I compute potential at all external grid points, improved}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01076}01076     \textcolor{comment}{!! version shall only compute it at external points in a switch region}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01077}01077     \textcolor{comment}{! Load input harmonics into tree data}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01078}01078     \textcolor{keywordflow}{if}(params \% lmax .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01079}01079         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01080}01080             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01081}01081             workspace \% tmp\_node\_m(:constants \% nbasis, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01082}01082                 \& workspace \% tmp\_sph(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01083}01083             workspace \% tmp\_node\_m(constants \% nbasis+1:, inode) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01084}01084 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01085}01085     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01086}01086         indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01087}01087         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01088}01088             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01089}01089             workspace \% tmp\_node\_m(:, inode) = workspace \% tmp\_sph(1:indl, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01090}01090 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01091}01091 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01092}01092     \textcolor{comment}{! Perform direct FMM matvec to all external grid points}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01093}01093     \textcolor{keyword}{call }tree\_m2m\_rotation(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01094}01094     \textcolor{keyword}{call }tree\_m2l\_rotation(params, constants, workspace \% tmp\_node\_m, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01095}01095         \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01096}01096     \textcolor{keyword}{call }tree\_l2l\_rotation(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01097}01097     \textcolor{keyword}{call }tree\_l2p(params, constants, one, workspace \% tmp\_node\_l, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01098}01098         \& workspace \% tmp\_grid, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01099}01099     \textcolor{keyword}{call }tree\_m2p(params, constants, params \% lmax, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01100}01100         \& workspace \% tmp\_sph, one, workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01101}01101     \textcolor{comment}{!! Compute gradients of L2L if pl > 0}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01102}01102     \textcolor{keywordflow}{if} (params \% pl .gt. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01103}01103         \textcolor{keyword}{call }tree\_grad\_l2l(params, constants, workspace \% tmp\_node\_l, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01104}01104             \& workspace \% tmp\_sph\_l\_grad, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01105}01105 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01106}01106     \textcolor{comment}{!! Diagonal update of computed grid values, that is needed for R\string^C, a part}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01107}01107     \textcolor{comment}{!! of R\string^A and a part of R\string^B}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01108}01108     \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, params \% nsph, constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01109}01109         \& pt5, constants \% vgrid2, constants \% vgrid\_nbasis, g, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01110}01110         \& constants \% nbasis, -\/one, workspace \% tmp\_grid, params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01111}01111     \textcolor{comment}{!! Scale temporary grid points by corresponding Lebedev weights and ygrid}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01112}01112     \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01113}01113         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01114}01114             workspace \% tmp\_grid(igrid, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01115}01115                 \& workspace \% tmp\_grid(igrid, isph) *  constants \% wgrid(igrid) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01116}01116                 \& ygrid(igrid, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01117}01117 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01118}01118 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01119}01119     \textcolor{comment}{!! Compute all terms of grad\_i(R). The second term of R\_i\string^B is already}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01120}01120     \textcolor{comment}{!! taken into account and the first term is computed together with R\_i\string^C.}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01121}01121     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01122}01122         \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01123}01123             \textcolor{comment}{! Loop over all neighbouring spheres}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01124}01124             \textcolor{keywordflow}{do} ik = constants \% inl(isph), constants \% inl(isph+1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01125}01125                 ksph = constants \% nl(ik)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01126}01126                 \textcolor{comment}{! Only consider external grid points}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01127}01127                 \textcolor{keywordflow}{if}(constants \% ui(igrid, ksph) .eq. zero) cycle}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01128}01128                 \textcolor{comment}{! build geometrical quantities}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01129}01129                 c = params \% csph(:, ksph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01130}01130                     \& params \% rsph(ksph)*constants \% cgrid(:, igrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01131}01131                 vki = c -\/ params \% csph(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01132}01132                 \textcolor{comment}{!vvki = sqrt(vki(1)*vki(1) + vki(2)*vki(2) + \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01133}01133                 \textcolor{comment}{!    \& vki(3)*vki(3))}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01134}01134                 vvki = dnrm2(3, vki, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01135}01135                 tki = vvki / params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01136}01136                 \textcolor{comment}{! Only consider such points where grad U is non-\/zero}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01137}01137                 \textcolor{keywordflow}{if}((tki.le.tlow) .or. (tki.ge.thigh)) cycle}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01138}01138                 \textcolor{comment}{! This is entire R\string^C and the first R\string^B component (grad\_i of U}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01139}01139                 \textcolor{comment}{! of a sum of R\_kj for index inequality j!=k)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01140}01140                 \textcolor{comment}{! Indexes k and j are flipped compared to the paper}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01141}01141                 gg = workspace \% tmp\_grid(igrid, ksph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01142}01142                 \textcolor{comment}{! Compute grad\_i component of forces using precomputed}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01143}01143                 \textcolor{comment}{! potential gg}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01144}01144                 \textcolor{comment}{!fx(:, isph) = fx(:, isph) -\/ \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01145}01145                 \textcolor{comment}{!    \& dfsw(tki, params \% se, params \% eta)/ \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01146}01146                 \textcolor{comment}{!    \& params \% rsph(isph)*constants \% wgrid(igrid)*gg* \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01147}01147                 \textcolor{comment}{!    \& ygrid(igrid, ksph)*(vki/vvki)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01148}01148                 fx(:, isph) = fx(:, isph) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01149}01149                     \& dfsw(tki, params \% se, params \% eta)/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01150}01150                     \& params \% rsph(isph)*gg*(vki/vvki)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01151}01151 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01152}01152             \textcolor{comment}{! contribution from the sphere itself}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01153}01153             \textcolor{keywordflow}{if}((constants \% ui(igrid,isph).gt.zero) .and. \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01154}01154                 \& (constants \% ui(igrid,isph).lt.one)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01155}01155                 \textcolor{comment}{! R\string^A component (grad\_i of U of a sum of R\_ij for index}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01156}01156                 \textcolor{comment}{! inequality j!=i)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01157}01157                 \textcolor{comment}{! Indexes k and j are flipped compared to the paper}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01158}01158                 gg = workspace \% tmp\_grid(igrid, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01159}01159                 \textcolor{comment}{! Compute grad\_i component of forces using precomputed}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01160}01160                 \textcolor{comment}{! potential gg}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01161}01161                 \textcolor{comment}{!fx(:, isph) = fx(:, isph) + constants \% wgrid(igrid)*gg* \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01162}01162                 \textcolor{comment}{!    \& ygrid(igrid, isph)*constants \% zi(:, igrid, isph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01163}01163                 fx(:, isph) = fx(:, isph) + gg*constants \% zi(:, igrid, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01164}01164 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01165}01165             \textcolor{keywordflow}{if} (constants \% ui(igrid, isph) .gt. zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01166}01166                 \textcolor{comment}{! Another R\string^A component (grad\_i of potential of a sum of R\_ij}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01167}01167                 \textcolor{comment}{! for index inequality j!=i)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01168}01168                 \textcolor{comment}{! Indexes k and j are flipped compared to the paper}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01169}01169                 \textcolor{comment}{! In case pl=0 MKL does not make gg3 zero reusing old value of}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01170}01170                 \textcolor{comment}{! gg3, so we have to clear it manually}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01171}01171                 gg3 = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01172}01172                 \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'T'}, params \% pl**2, 3, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01173}01173                     \& workspace \% tmp\_sph\_l\_grad(1, 1, isph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01174}01174                     \& (params \% pl+1)**2, constants \% vgrid2(1, igrid), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01175}01175                     \& zero, gg3, 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01176}01176                 \textcolor{comment}{! Gradient of the near-\/field potential is a gradient of}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01177}01177                 \textcolor{comment}{! multipole expansion}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01178}01178                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01179}01179                 \textcolor{keywordflow}{do} inear = constants \% snear(inode), constants \% snear(inode+1)-\/1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01180}01180                     jnode = constants \% near(inear)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01181}01181                     \textcolor{keywordflow}{do} jsph\_node = constants \% cluster(1, jnode), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01182}01182                         \& constants \% cluster(2, jnode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01183}01183                         jsph = constants \% order(jsph\_node)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01184}01184                         \textcolor{keywordflow}{if} (isph .eq. jsph) cycle}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01185}01185                         c = params \% csph(:, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01186}01186                             \& params \% rsph(isph)*constants \% cgrid(:, igrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01187}01187                         \textcolor{keyword}{call }fmm\_m2p\_work(c-\/params \% csph(:, jsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01188}01188                             \& params \% rsph(jsph), params \% lmax+1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01189}01189                             \& constants \% vscales\_rel, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01190}01190                             \& workspace \% tmp\_sph\_grad(:, 1, jsph), zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01191}01191                             \& tmp\_gg, work)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01192}01192                         gg3(1) = gg3(1) + tmp\_gg}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01193}01193                         \textcolor{keyword}{call }fmm\_m2p\_work(c-\/params \% csph(:, jsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01194}01194                             \& params \% rsph(jsph), params \% lmax+1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01195}01195                             \& constants \% vscales\_rel, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01196}01196                             \& workspace \% tmp\_sph\_grad(:, 2, jsph), zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01197}01197                             \& tmp\_gg, work)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01198}01198                         gg3(2) = gg3(2) + tmp\_gg}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01199}01199                         \textcolor{keyword}{call }fmm\_m2p\_work(c-\/params \% csph(:, jsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01200}01200                             \& params \% rsph(jsph), params \% lmax+1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01201}01201                             \& constants \% vscales\_rel, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01202}01202                             \& workspace \% tmp\_sph\_grad(:, 3, jsph), zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01203}01203                             \& tmp\_gg, work)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01204}01204                         gg3(3) = gg3(3) + tmp\_gg}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01205}01205 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01206}01206 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01207}01207                 \textcolor{comment}{! Accumulate all computed forces}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01208}01208                 fx(:, isph) = fx(:, isph) -\/ constants \% wgrid(igrid)*gg3* \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01209}01209                     \& ygrid(igrid, isph)*constants \% ui(igrid, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01210}01210 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01211}01211 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01212}01212 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01213}01213 \textcolor{keyword}{end subroutine }gradr\_fmm}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01214}01214 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01215}01215 \textcolor{keyword}{subroutine }bstarx(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01216}01216     \textcolor{comment}{! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01217}01217     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01218}01218     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01219}01219     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01220}01220 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01221}01221 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: y(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01222}01222     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01223}01223     \textcolor{keywordtype}{integer} :: isph, jsph, ij, indmat, igrid, iproc}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01224}01224     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01225}01225     \textcolor{keywordflow}{if} (params \% matvecmem .eq. 1) \textcolor{keywordflow}{then} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01226}01226         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01227}01227         \textcolor{comment}{!\$omp private(isph,ij,jsph,indmat) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01228}01228         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01229}01229             \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph + 1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01230}01230                 jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01231}01231                 indmat = constants \% itrnl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01232}01232                 \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'t'}, constants \% nbasis, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01233}01233                     \& constants \% b(:,:,indmat), constants \% nbasis, x(:,jsph), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01234}01234                     \& one, y(:,isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01235}01235 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01236}01236 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01237}01237     \textcolor{keywordflow}{else} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01238}01238         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01239}01239         \textcolor{comment}{!\$omp private(isph) schedule(static,1)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01240}01240         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01241}01241             \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'t'}, constants \% nbasis, params \% ngrid, one, constants \% vgrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01242}01242                 \& constants \% vgrid\_nbasis, x(:, isph), 1, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01243}01243                 \& workspace \% tmp\_grid(:, isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01244}01244 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01245}01245         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01246}01246         \textcolor{comment}{!\$omp private(isph,iproc) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01247}01247         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01248}01248             iproc = omp\_get\_thread\_num() + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01249}01249             \textcolor{keyword}{call }adjrhs\_lpb(params, constants, workspace, isph, workspace \% tmp\_grid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01250}01250                 \& y(:, isph), workspace \% tmp\_vylm(:, iproc), workspace \% tmp\_vplm(:, iproc), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01251}01251                 \& workspace \% tmp\_vcos(:, iproc), workspace \% tmp\_vsin(:, iproc), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01252}01252                 \& workspace \% tmp\_bessel(:, iproc))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01253}01253             y(:,isph)  = -\/ y(:,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01254}01254 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01255}01255 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01256}01256 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01257}01257     \textcolor{comment}{! add the diagonal if required}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01258}01258     \textcolor{keywordflow}{if} (constants \% dodiag) y = y + x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01259}01259 \textcolor{keyword}{end subroutine }bstarx}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01260}01260 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01266}\mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{01266}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{bx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01267}01267     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01268}01268     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01269}01269     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01270}01270     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01271}01271 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01272}01272 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01273}01273     \textcolor{keywordtype}{integer} :: isph, jsph, ij, iproc}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01274}01274 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01275}01275     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01276}01276     \textcolor{keywordflow}{if} (params \% matvecmem .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01277}01277         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01278}01278         \textcolor{comment}{!\$omp private(isph,ij,jsph) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01279}01279         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01280}01280             \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph + 1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01281}01281                 jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01282}01282                 \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'n'}, constants \% nbasis, constants \% nbasis, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01283}01283                     \& constants \% b(:,:,ij), constants \% nbasis, x(:,jsph), 1, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01284}01284                     \& one, y(:,isph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01285}01285 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01286}01286 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01287}01287     \textcolor{keywordflow}{else} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01288}01288         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace,x,y) \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01289}01289         \textcolor{comment}{!\$omp private(isph,iproc) schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01290}01290         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01291}01291           iproc = omp\_get\_thread\_num() + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01292}01292           \textcolor{keyword}{call }calcv2\_lpb(params, constants, isph, workspace \% tmp\_pot(:, iproc), x, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01293}01293               \& workspace \% tmp\_vylm, workspace \% tmp\_vplm, workspace \% tmp\_vcos, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01294}01294               \& workspace \% tmp\_vsin, workspace \% tmp\_bessel)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01295}01295           \textcolor{keyword}{call }ddintegrate(1, constants \% nbasis, params \% ngrid, constants \% vwgrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01296}01296               \& constants \% vgrid\_nbasis, workspace \% tmp\_pot(:, iproc), y(:,isph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01297}01297           y(:,isph) = -\/ y(:,isph) }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01298}01298 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01299}01299 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01300}01300     \textcolor{keywordflow}{if} (constants \% dodiag) y = y + x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01301}01301 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{bx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01302}01302 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01307}\mbox{\hyperlink{namespaceddx__operators_a92077fecd6f7c3ab9b4be15323cdadb2}{01307}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a92077fecd6f7c3ab9b4be15323cdadb2}{tx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01308}01308     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01309}01309     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01310}01310     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01311}01311     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01312}01312 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01313}01313 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01314}01314 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01315}01315 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)} :: temp\_vector}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01316}01316     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01317}01317     temp\_vector = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01318}01318 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01319}01319     \textcolor{comment}{! Compute AXr}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01320}01320     \textcolor{comment}{! call LXr}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01321}01321     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{lx}}(params, constants, workspace, x(:,:,1), temp\_vector(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01322}01322     \textcolor{comment}{! Remove the scaling factor}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01323}01323     \textcolor{keyword}{call }convert\_ddcosmo(params, constants, 1, temp\_vector(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01324}01324     y(:,:,1) = y(:,:,1) + temp\_vector(:,:,1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01325}01325     \textcolor{comment}{! Compute BXe}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01326}01326     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{bx}}(params, constants, workspace, x(:,:,2), temp\_vector(:,:,2))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01327}01327     y(:,:,2) = y(:,:,2) + temp\_vector(:,:,2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01328}01328 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01329}01329     \textcolor{comment}{! Reset temp\_vector to zero}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01330}01330     temp\_vector = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01331}01331     \textcolor{comment}{! Call CX}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01332}01332     \textcolor{keyword}{call }cx(params, constants, workspace, x, temp\_vector)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01333}01333     y = y + temp\_vector}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01334}01334 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a92077fecd6f7c3ab9b4be15323cdadb2}{tx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01335}01335 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01340}\mbox{\hyperlink{namespaceddx__operators_a255d38c63d567d20e2844c8d015d1c0f}{01340}} \textcolor{keyword}{subroutine }\mbox{\hyperlink{namespaceddx__operators_a255d38c63d567d20e2844c8d015d1c0f}{tstarx}}(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01341}01341     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01342}01342     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01343}01343     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01344}01344     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01345}01345 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01346}01346 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01347}01347 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01348}01348 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)} :: temp\_vector}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01349}01349     y = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01350}01350     temp\_vector = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01351}01351 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01352}01352     \textcolor{comment}{! Compute AXr}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01353}01353     \textcolor{comment}{! call LstarXr}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01354}01354     \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{lstarx}}(params, constants, workspace, x(:,:,1), temp\_vector(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01355}01355     \textcolor{comment}{! Remove the scaling factor}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01356}01356     \textcolor{keyword}{call }convert\_ddcosmo(params, constants, 1, temp\_vector(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01357}01357     y(:,:,1) = y(:,:,1) + temp\_vector(:,:,1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01358}01358     \textcolor{comment}{! Compute BXe}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01359}01359     \textcolor{keyword}{call }bstarx(params, constants, workspace, x(:,:,2), temp\_vector(:,:,2))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01360}01360     y(:,:,2) = y(:,:,2) + temp\_vector(:,:,2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01361}01361 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01362}01362     \textcolor{comment}{! Reset temp\_vector to zero}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01363}01363     temp\_vector = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01364}01364     \textcolor{comment}{! Call CX}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01365}01365     \textcolor{keyword}{call }cstarx(params, constants, workspace, x, temp\_vector)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01366}01366     y = y + temp\_vector}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01367}01367 \textcolor{keyword}{end subroutine }\mbox{\hyperlink{namespaceddx__operators_a255d38c63d567d20e2844c8d015d1c0f}{tstarx}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01368}01368 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01369}01369 \textcolor{keyword}{subroutine }bx\_prec(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01370}01370     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01371}01371     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01372}01372     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01373}01373     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01374}01374 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01375}01375 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01376}01376     y = x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01377}01377 \textcolor{keyword}{end subroutine }bx\_prec}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01378}01378 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01379}01379 \textcolor{keyword}{subroutine }prec\_tstarx(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01380}01380     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01381}01381     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01382}01382     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01383}01383     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01384}01384 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01385}01385 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(inout)} :: y(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01386}01386     \textcolor{keywordtype}{integer} :: n\_iter, info}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01387}01387 \textcolor{keywordtype}{    real}(dp) :: r\_norm}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01388}01388 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% maxiter)} :: x\_rel\_diff}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01389}01389 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01390}01390     y(:,:,1) = x(:,:,1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01391}01391     \textcolor{keyword}{call }convert\_ddcosmo(params, constants, 1, y(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01392}01392     n\_iter = params \% maxiter}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01393}01393     \textcolor{keywordflow}{if} (params \% itersolver .eq. 1) \textcolor{keywordflow}{then} }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01394}01394         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}(params, constants, workspace, constants \% inner\_tol, y(:,:,1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01395}01395             \& workspace \% ddcosmo\_guess, n\_iter, x\_rel\_diff, \mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{lstarx}}, \mbox{\hyperlink{namespaceddx__operators_a73668d47230f4292955012f9910e4ecc}{ldm1x}}, hnorm, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01396}01396     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01397}01397         \textcolor{keyword}{call }gmresr(params, constants, workspace, constants \% inner\_tol, y(:,:,1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01398}01398             \& workspace \% ddcosmo\_guess, n\_iter, r\_norm, \mbox{\hyperlink{namespaceddx__operators_a6f210175b888b158774e507e0d603b52}{lstarx}}, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01399}01399 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01400}01400     \textcolor{keywordflow}{if} (info.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01401}01401         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'prec\_tstarx: [1] ddCOSMO failed to converge'}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01402}01402         stop 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01403}01403 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01404}01404     y(:,:,1) = workspace \% ddcosmo\_guess}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01405}01405 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01406}01406     n\_iter = params \% maxiter}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01407}01407     \textcolor{keywordflow}{if} (params \% itersolver .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01408}01408         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}(params, constants, workspace, constants \% inner\_tol, x(:,:,2), workspace \% hsp\_guess, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01409}01409             \& n\_iter, x\_rel\_diff, bstarx, bx\_prec, hnorm, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01410}01410     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01411}01411         \textcolor{keyword}{call }gmresr(params, constants, workspace, constants \% inner\_tol, x(:,:,2), workspace \% hsp\_guess, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01412}01412            \& n\_iter, r\_norm, bstarx, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01413}01413 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01414}01414     \textcolor{keywordflow}{if} (info.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01415}01415         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'prec\_tstarx: [1] HSP failed to converge'}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01416}01416         stop 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01417}01417 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01418}01418     y(:,:,2) = workspace \% hsp\_guess}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01419}01419 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01420}01420 \textcolor{keyword}{end subroutine }prec\_tstarx}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01421}01421 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01422}01422 \textcolor{comment}{! apply preconditioner}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01423}01423 \textcolor{comment}{! |Yr| = |A\string^-\/1 0 |*|Xr|}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01424}01424 \textcolor{comment}{! |Ye|   |0 B\string^-\/1 | |Xe|}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01425}01425 \textcolor{comment}{! @param[in] ddx\_data : dd Data}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01426}01426 \textcolor{comment}{! @param[in] x        : Input array}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01427}01427 \textcolor{comment}{! @param[out] y       : Linear system solution at current iteration}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01428}01428 \textcolor{keyword}{subroutine }prec\_tx(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01429}01429     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01430}01430     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01431}01431     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01432}01432     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01433}01433 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: x(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01434}01434 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(inout)} :: y(constants \% nbasis, params \% nsph, 2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01435}01435     \textcolor{keywordtype}{integer} :: n\_iter, info}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01436}01436 \textcolor{keywordtype}{    real}(dp) :: r\_norm}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01437}01437 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% maxiter)} :: x\_rel\_diff}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01438}01438 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01439}01439     \textcolor{comment}{! perform A\string^-\/1 * Yr}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01440}01440     n\_iter = params \% maxiter}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01441}01441     \textcolor{keywordflow}{if} (params \% itersolver .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01442}01442         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}(params, constants, workspace, constants \% inner\_tol, x(:,:,1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01443}01443             \& workspace \% ddcosmo\_guess, n\_iter, x\_rel\_diff, \mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{lx}}, \mbox{\hyperlink{namespaceddx__operators_a73668d47230f4292955012f9910e4ecc}{ldm1x}}, hnorm, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01444}01444     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01445}01445         \textcolor{keyword}{call }gmresr(params, constants, workspace, constants \% inner\_tol, x(:,:,1), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01446}01446             \& workspace \% ddcosmo\_guess, n\_iter, r\_norm, \mbox{\hyperlink{namespaceddx__operators_ac2a84b8394941ee2bf6d8f3e44127be3}{lx}}, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01447}01447 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01448}01448     \textcolor{keywordflow}{if} (info.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01449}01449         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'prec\_tx: [1] ddCOSMO failed to converge'}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01450}01450         stop 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01451}01451 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01452}01452 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01453}01453     \textcolor{comment}{! Scale by the factor of (2l+1)/4Pi}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01454}01454     y(:,:,1) = workspace \% ddcosmo\_guess}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01455}01455     \textcolor{keyword}{call }convert\_ddcosmo(params, constants, 1, y(:,:,1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01456}01456 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01457}01457     \textcolor{comment}{! perform B\string^-\/1 * Ye}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01458}01458     n\_iter = params \% maxiter}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01459}01459     \textcolor{keywordflow}{if} (params \% itersolver .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01460}01460         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__solvers_abf126087f0449850ca561c364488f20a}{jacobi\_diis}}(params, constants, workspace, constants \% inner\_tol, x(:,:,2), workspace \% hsp\_guess, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01461}01461             \& n\_iter, x\_rel\_diff, \mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{bx}}, bx\_prec, hnorm, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01462}01462     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01463}01463         \textcolor{keyword}{call }gmresr(params, constants, workspace, constants \% inner\_tol, x(:,:,2), workspace \% hsp\_guess, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01464}01464          \& n\_iter, r\_norm, \mbox{\hyperlink{namespaceddx__operators_a68303147fb9fe072ab34096910280f1a}{bx}}, info)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01465}01465 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01466}01466     y(:,:,2) = workspace \% hsp\_guess}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01467}01467 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01468}01468     \textcolor{keywordflow}{if} (info.ne.0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01469}01469         \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'prec\_tx: [1] HSP failed to converge'}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01470}01470         stop 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01471}01471 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01472}01472 \textcolor{keyword}{end subroutine }prec\_tx}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01473}01473 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01474}01474 \textcolor{keyword}{subroutine }cstarx(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01475}01475     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01476}01476     \textcolor{comment}{! input/output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01477}01477     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01478}01478     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01479}01479     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01480}01480 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01481}01481 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01482}01482     \textcolor{comment}{! local}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01483}01483 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(0:constants \% lmax0)} :: SK\_rijn, DK\_rijn}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01484}01484 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)} :: basloc, vplm}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01485}01485 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% lmax + 1)} :: vcos, vsin}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01486}01486     \textcolor{keywordtype}{complex(dp)} :: bessel\_work(max(2, params \% lmax+1))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01487}01487     \textcolor{keywordtype}{complex(dp)} :: work\_complex(constants \% lmax0+1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01488}01488 \textcolor{keywordtype}{    real}(dp) :: work(constants \% lmax0+1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01489}01489     \textcolor{keywordtype}{integer} :: isph, igrid, jsph, ind, l0, m0, ind0, indl, inode, l, m}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01490}01490 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(3)} :: vij, vtij}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01491}01491 \textcolor{keywordtype}{    real}(dp) :: val, epsilon\_ratio}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01492}01492 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{allocatable} :: scratch(:,:), scratch0(:,:)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01493}01493 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01494}01494     \textcolor{keyword}{allocate}(scratch(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01495}01495         \& scratch0(constants \% nbasis0, params \% nsph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01496}01496 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01497}01497     epsilon\_ratio = params \% epsp/params \% eps}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01498}01498 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01499}01499     \textcolor{comment}{! TODO: maybe use ddeval\_grid for code consistency}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01500}01500     scratch = -\/ x(:,:,1) -\/ x(:,:,2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01501}01501     \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, params \% nsph, constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01502}01502         \& one, constants \% vwgrid, constants \% vgrid\_nbasis, scratch, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01503}01503         \& constants \% nbasis, zero, workspace \% tmp\_grid, params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01504}01504 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01505}01505     scratch0 = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01506}01506     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01507}01507         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01508}01508             \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01509}01509                 \textcolor{keywordflow}{if} (constants \% ui(igrid, isph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01510}01510                     val = workspace \% tmp\_grid(igrid,isph) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01511}01511                         \& *constants \% ui(igrid,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01512}01512                     \textcolor{comment}{! quadratically scaling loop}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01513}01513                     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01514}01514                         vij  = params \% csph(:,isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01515}01515                             \& params \% rsph(isph)*constants \% cgrid(:,igrid) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01516}01516                             \& params \% csph(:,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01517}01517                         vtij = vij * params \% kappa}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01518}01518                         \textcolor{keyword}{call }fmm\_m2p\_bessel\_adj\_work(vtij, val, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01519}01519                             \& constants \% SK\_ri(:, jsph), constants \% lmax0, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01520}01520                             \& constants \% vscales, one, scratch0(:, jsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01521}01521                             \& work\_complex, work)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01522}01522 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01523}01523 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01524}01524 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01525}01525 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01526}01526     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01527}01527         \textcolor{comment}{! Multiply by characteristic function}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01528}01528         workspace \% tmp\_grid = workspace \% tmp\_grid * constants \% ui}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01529}01529         workspace \% tmp\_sph = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01530}01530         \textcolor{comment}{! Do FMM operations adjointly}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01531}01531         \textcolor{keyword}{call }tree\_m2p\_bessel\_adj(params, constants, constants \% lmax0, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01532}01532             \& one, workspace \% tmp\_grid, zero, params \% lmax, workspace \% tmp\_sph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01533}01533         \textcolor{keyword}{call }tree\_l2p\_bessel\_adj(params, constants, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01534}01534             \& workspace \% tmp\_grid, zero, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01535}01535         \textcolor{keyword}{call }tree\_l2l\_bessel\_rotation\_adj(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01536}01536             \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01537}01537         \textcolor{keyword}{call }tree\_m2l\_bessel\_rotation\_adj(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01538}01538             \& workspace \% tmp\_node\_l, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01539}01539         \textcolor{keyword}{call }tree\_m2m\_bessel\_rotation\_adj(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01540}01540             \& workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01541}01541         \textcolor{comment}{! Adjointly move tree multipole harmonics into output}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01542}01542         \textcolor{keywordflow}{if}(constants \% lmax0 .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01543}01543             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01544}01544                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01545}01545                 scratch0(:, isph) = workspace \% tmp\_sph(1:constants \% nbasis0, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01546}01546                     \& workspace \% tmp\_node\_m(1:constants \% nbasis0, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01547}01547 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01548}01548         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01549}01549             indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01550}01550             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01551}01551                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01552}01552                 scratch0(1:indl, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01553}01553                     \& workspace \% tmp\_sph(1:indl, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01554}01554                     \& workspace \% tmp\_node\_m(:, inode)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01555}01555                 scratch0(indl+1:, isph) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01556}01556 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01557}01557 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01558}01558 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01559}01559     \textcolor{comment}{! Scale by C\_ik}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01560}01560     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01561}01561         \textcolor{keywordflow}{do} l0 = 0, constants \% lmax0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01562}01562             ind0 = l0*l0 + l0 + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01563}01563             scratch0(ind0-\/l0:ind0+l0, isph) = scratch0(ind0-\/l0:ind0+l0, isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01564}01564                 \& constants \% C\_ik(l0, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01565}01565 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01566}01566 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01567}01567 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01568}01568     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01569}01569         \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'n'}, constants \% nbasis, constants \% nbasis0, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01570}01570             \& constants \% pchi(1,1,jsph), constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01571}01571             \& scratch0(1,jsph), 1, zero, scratch(1,jsph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01572}01572 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01573}01573 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01574}01574     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01575}01575         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01576}01576             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01577}01577                 ind = l**2 + l + m + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01578}01578                 y(ind,isph,1) = -\/ (epsilon\_ratio*l*scratch(ind,isph)) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01579}01579                     \& /params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01580}01580                 y(ind,isph,2) = constants \% termimat(l,isph)*scratch(ind,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01581}01581 \textcolor{keywordflow}{          end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01582}01582 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01583}01583 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01584}01584 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01585}01585 \textcolor{keyword}{end subroutine }cstarx}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01586}01586 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01587}01587 \textcolor{comment}{! Perform |Yr| = |C1 C2|*|Xr|}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01588}01588 \textcolor{comment}{!         |Ye|   |C1 C2| |Xe|}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01589}01589 \textcolor{comment}{! @param[in] ddx\_data : dd Data}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01590}01590 \textcolor{comment}{! @param[in] x        : Input array X (Xr, Xe)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01591}01591 \textcolor{comment}{! @param[out] y       : Matrix-\/vector product result Y}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01592}01592 \textcolor{keyword}{subroutine }cx(params, constants, workspace, x, y)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01593}01593     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01594}01594     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01595}01595     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01596}01596     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01597}01597 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01598}01598 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph, 2)}, \textcolor{keywordtype}{intent(out)} :: y}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01599}01599 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01600}01600     \textcolor{keywordtype}{integer} :: isph, jsph, igrid, ind, l, m, ind0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01601}01601 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(3)} :: sijn ,vij, vtij}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01602}01602 \textcolor{keywordtype}{    real}(dp) :: term, rho, ctheta, stheta, cphi, sphi, rijn, val}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01603}01603 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)} :: basloc, vplm}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01604}01604 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% lmax + 1)} :: vcos, vsin}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01605}01605 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% lmax0 + 1)} :: SK\_rijn, DK\_rijn}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01606}01606     \textcolor{keywordtype}{complex(dp)} :: work\_complex(constants \% lmax0 + 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01607}01607 \textcolor{keywordtype}{    real}(dp) :: work(constants \% lmax0 + 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01608}01608     \textcolor{keywordtype}{integer} :: indl, inode}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01609}01609 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01610}01610 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{allocatable} :: diff\_re(:,:), diff0(:,:)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01611}01611     \textcolor{keyword}{allocate}(diff\_re(constants \% nbasis, params \% nsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01612}01612         \& diff0(constants \% nbasis0, params \% nsph))}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01613}01613 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01614}01614     \textcolor{comment}{! diff\_re = params \% epsp/eps*l1/ri*Xr -\/ i'(ri)/i(ri)*Xe,}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01615}01615     diff\_re = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01616}01616     \textcolor{comment}{!\$omp parallel do default(none) shared(params,diff\_re, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01617}01617     \textcolor{comment}{!\$omp constants,x) private(jsph,l,m,ind)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01618}01618     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01619}01619       \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01620}01620         \textcolor{keywordflow}{do} m = -\/l,l}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01621}01621           ind = l**2 + l + m + 1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01622}01622           diff\_re(ind,jsph) = (params \% epsp/params \% eps)* \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01623}01623               \& (l/params \% rsph(jsph))*x(ind,jsph,1) \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01624}01624               \& -\/ constants \% termimat(l,jsph)*x(ind,jsph,2)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01625}01625 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01626}01626 \textcolor{keywordflow}{      end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01627}01627 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01628}01628 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01629}01629     \textcolor{comment}{! diff0 = Pchi * diff\_er, linear scaling}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01630}01630     \textcolor{comment}{!\$omp parallel do default(none) shared(constants,params, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01631}01631     \textcolor{comment}{!\$omp diff\_re,diff0) private(jsph)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01632}01632     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01633}01633       \textcolor{keyword}{call }dgemv(\textcolor{stringliteral}{'t'}, constants \% nbasis, constants \% nbasis0, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01634}01634           \& constants \% pchi(1,1,jsph), constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01635}01635           \& diff\_re(1,jsph), 1, zero, diff0(1,jsph), 1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01636}01636 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01637}01637 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01638}01638     \textcolor{comment}{! Multiply diff0 by C\_ik inplace}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01639}01639     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01640}01640         \textcolor{keywordflow}{do} l = 0, constants \% lmax0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01641}01641             ind0 = l*l+l+1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01642}01642             diff0(ind0-\/l:ind0+l, isph) = diff0(ind0-\/l:ind0+l, isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01643}01643                 \& constants \% C\_ik(l, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01644}01644 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01645}01645 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01646}01646     \textcolor{comment}{! avoiding N\string^2 storage, this code does not use the cached coefY}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01647}01647     y(:,:,1) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01648}01648     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01649}01649         \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01650}01650         \textcolor{comment}{!\$omp diff0,y) private(isph,igrid,val,vij,rijn,sijn,SK\_rijn, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01651}01651         \textcolor{comment}{!\$omp DK\_rijn,work,rho,ctheta,stheta,cphi,sphi,basloc,vplm, \&}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01652}01652         \textcolor{comment}{!\$omp vcos,vsin,term,ind0,ind,vtij,work\_complex)}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01653}01653         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01654}01654             \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01655}01655                 \textcolor{keywordflow}{if} (constants \% ui(igrid,isph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01656}01656                     val = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01657}01657 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01658}01658                     \textcolor{comment}{! quadratically scaling loop}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01659}01659                     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01660}01660                         vij  = params \% csph(:,isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01661}01661                             \& params \% rsph(isph)*constants \% cgrid(:,igrid) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01662}01662                             \& params \% csph(:,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01663}01663                         vtij = vij * params \% kappa}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01664}01664                         \textcolor{keyword}{call }fmm\_m2p\_bessel\_work(vtij, constants \% lmax0, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01665}01665                             \& constants \% vscales, constants \% SK\_ri(:, jsph), \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01666}01666                             \& one, diff0(:, jsph), one, val, work\_complex, work)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01667}01667 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01668}01668                     \textcolor{keywordflow}{do} ind = 1, constants \% nbasis}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01669}01669                         y(ind,isph,1) = y(ind,isph,1) + val*\&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01670}01670                           \& constants \% ui(igrid,isph)*\&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01671}01671                           \& constants \% vwgrid(ind,igrid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01672}01672 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01673}01673 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01674}01674 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01675}01675 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01676}01676     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01677}01677         \textcolor{comment}{! Load input harmonics into tree data}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01678}01678         workspace \% tmp\_node\_m = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01679}01679         workspace \% tmp\_node\_l = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01680}01680         workspace \% tmp\_sph = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01681}01681         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01682}01682             \textcolor{keywordflow}{do} l = 0, constants \% lmax0}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01683}01683                 ind0 = l*l+l+1}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01684}01684                 workspace \% tmp\_sph(ind0-\/l:ind0+l, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01685}01685                     \& diff0(ind0-\/l:ind0+l, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01686}01686 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01687}01687 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01688}01688         \textcolor{keywordflow}{if}(constants \% lmax0 .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01689}01689             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01690}01690                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01691}01691                 workspace \% tmp\_node\_m(1:constants \% nbasis0, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01692}01692                     \& workspace \% tmp\_sph(1:constants \% nbasis0, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01693}01693                 workspace \% tmp\_node\_m(constants \% nbasis0+1:, inode) = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01694}01694 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01695}01695         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01696}01696             indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01697}01697             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01698}01698                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01699}01699                 workspace \% tmp\_node\_m(:, inode) = workspace \% tmp\_sph(1:indl, isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01700}01700 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01701}01701 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01702}01702         \textcolor{comment}{! Do FMM operations}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01703}01703         \textcolor{keyword}{call }tree\_m2m\_bessel\_rotation(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01704}01704         \textcolor{keyword}{call }tree\_m2l\_bessel\_rotation(params, constants, workspace \% tmp\_node\_m, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01705}01705             \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01706}01706         \textcolor{keyword}{call }tree\_l2l\_bessel\_rotation(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01707}01707         workspace \% tmp\_grid = zero}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01708}01708         \textcolor{keyword}{call }tree\_l2p\_bessel(params, constants, one, workspace \% tmp\_node\_l, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01709}01709             \& workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01710}01710         \textcolor{keyword}{call }tree\_m2p\_bessel(params, constants, constants \% lmax0, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01711}01711             \& params \% lmax, workspace \% tmp\_sph, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01712}01712             \& workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01713}01713 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01714}01714         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01715}01715             \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01716}01716                 \textcolor{keywordflow}{do} ind = 1, constants \% nbasis}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01717}01717                     y(ind,isph,1) = y(ind,isph,1) + workspace \% tmp\_grid(igrid, isph)*\&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01718}01718                         \& constants \% vwgrid(ind, igrid)*\&}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01719}01719                         \& constants \% ui(igrid,isph)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01720}01720 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01721}01721 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01722}01722 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01723}01723 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01724}01724 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01725}01725     y(:,:,2) = y(:,:,1)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01726}01726     \textcolor{keyword}{deallocate}(diff\_re, diff0)}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01727}01727 }
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01728}01728 \textcolor{keyword}{end subroutine }cx}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01729}01729 \textcolor{keyword}{end module }\mbox{\hyperlink{namespaceddx__operators}{ddx\_operators}}}
\DoxyCodeLine{\Hypertarget{ddx__operators_8f90_source_l01730}01730 }

\end{DoxyCode}
