\hypertarget{ddx__lpb__core_8f90_source}{}\doxysection{ddx\+\_\+lpb\+\_\+core.\+f90}
\label{ddx__lpb__core_8f90_source}\index{src/ddx\_lpb\_core.f90@{src/ddx\_lpb\_core.f90}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00009}00009 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00011}\mbox{\hyperlink{namespaceddx__lpb__core}{00011}} \textcolor{keyword}{module} \mbox{\hyperlink{namespaceddx__lpb__core}{ddx\_lpb\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00012}00012 \textcolor{comment}{! Get the core-\/routines}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00013}00013 \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__core}{ddx\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00014}00014 \textcolor{comment}{!}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00015}00015 \textcolor{keyword}{contains}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00016}00016 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00026}\mbox{\hyperlink{namespaceddx__lpb__core_a651dd3cdefb7b8f3c10d6914f61e35dc}{00026}} \textcolor{keyword}{subroutine }wghpot\_f(params, constants, workspace, gradphi, f)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00027}00027     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00028}00028     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00029}00029     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00030}00030 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: gradphi(3, constants \% ncav)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00031}00031     \textcolor{comment}{!! Temporary buffers}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00032}00032     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00033}00033     \textcolor{comment}{!! Outputs}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00034}00034 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: f(params \% ngrid, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00035}00035     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00036}00036     \textcolor{keywordtype}{integer} :: isph, ig, ic, ind, ind0, jg, l, m, jsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00037}00037 \textcolor{keywordtype}{    real}(dp) :: nderphi, sumSijn, rijn, coef\_Ylm, sumSijn\_pre, termi, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00038}00038         \& termk, term, tmp1, tmp2}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00039}00039     \textcolor{keywordtype}{real(dp)}, \textcolor{keywordtype}{dimension(3)} :: sijn, vij, vtij}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00040}00040 \textcolor{keywordtype}{    real}(dp) :: rho, ctheta, stheta, cphi, sphi, start\_time, finish\_time}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00041}00041 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{allocatable} :: SK\_rijn(:), DK\_rijn(:), c0(:,:), c1(:,:)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00042}00042     \textcolor{keywordtype}{integer} :: l0, m0, icav, istatus, indl, inode}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00043}00043     \textcolor{keywordtype}{complex(dp)} :: work\_complex(constants \% lmax0 + 1)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00044}00044 \textcolor{keywordtype}{    real}(dp) :: work(constants \% lmax0 + 1)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00045}00045 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00046}00046 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00047}00047     \textcolor{keyword}{allocate}(sk\_rijn(0:constants \% lmax0), dk\_rijn(0:constants \% lmax0), \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00048}00048         \& c0(constants \% nbasis0, params \% nsph), c1(constants \% nbasis0, params \% nsph))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00049}00049 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00050}00050     ic = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00051}00051     f = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00052}00052     c0 = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00053}00053     c1 = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00054}00054 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00055}00055     \textcolor{comment}{! Compute c0 Eq.(98) QSM19.SISC}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00056}00056     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00057}00057         \textcolor{keywordflow}{do} ig = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00058}00058             \textcolor{keywordflow}{if} (constants \% ui(ig, isph) .ne. zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00059}00059                 ic = ic + 1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00060}00060                 nderphi = dot\_product(gradphi(:, ic), constants \% cgrid(:,ig))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00061}00061                 c0(:, isph) = c0(:, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00062}00062                     \& constants \% wgrid(ig)*constants \% ui(ig,isph)*\&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00063}00063                     \& nderphi*constants \% vgrid(1:constants \% nbasis0,ig)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00064}00064                 \textcolor{keywordflow}{do} l0 = 0, constants \% lmax0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00065}00065                     ind0 = l0*l0 + 1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00066}00066                     ind = ind0 + 2*l0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00067}00067                     c1(ind0:ind, isph) = constants \% C\_ik(l0, isph) * \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00068}00068                         \& c0(ind0:ind, isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00069}00069 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00070}00070 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00071}00071 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00072}00072 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00073}00073 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00074}00074     \textcolor{comment}{! Computation of F0 using above terms}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00075}00075     \textcolor{comment}{! icav: External grid poitns}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00076}00076     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00077}00077         icav = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00078}00078         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00079}00079             \textcolor{keywordflow}{do} ig = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00080}00080                 \textcolor{keywordflow}{if} (constants \% ui(ig,isph).gt.zero) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00081}00081                     icav = icav + 1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00082}00082                     sumsijn = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00083}00083                     \textcolor{comment}{! Loop to compute Sijn}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00084}00084                     \textcolor{keywordflow}{do} jsph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00085}00085                         sumsijn\_pre = sumsijn}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00086}00086                         vij  = params \% csph(:,isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00087}00087                             \& params \% rsph(isph)*constants \% cgrid(:,ig) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00088}00088                             \& params \% csph(:,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00089}00089                         vtij = vij*params \% kappa}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00090}00090                         \textcolor{keyword}{call }fmm\_m2p\_bessel\_work(vtij, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00091}00091                             \& constants \% lmax0, constants \% vscales, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00092}00092                             \& constants \% SK\_ri(:, jsph), one, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00093}00093                             \& c1(:, jsph), one, sumsijn, work\_complex, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00094}00094 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00095}00095                     \textcolor{comment}{! Here Intermediate value of F\_0 is computed Eq. (99)}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00096}00096                     \textcolor{comment}{! Mutilplication with Y\_lm and weights will happen afterwards}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00097}00097                     \textcolor{comment}{!write(6,*) sumSijn, epsp, eps, ddx\_data \% constants \% ui(ig,isph)}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00098}00098                     f(ig,isph) = -\/(params \% epsp/params \% eps)*constants \% ui(ig,isph) * sumsijn}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00099}00099 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00100}00100 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00101}00101 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00102}00102     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00103}00103         \textcolor{comment}{! Load input harmonics into tree data}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00104}00104         workspace \% tmp\_node\_m = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00105}00105         workspace \% tmp\_node\_l = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00106}00106         workspace \% tmp\_sph = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00107}00107         workspace \% tmp\_sph(1:constants \% nbasis0, :) = c1(:, :)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00108}00108         \textcolor{keywordflow}{if}(constants \% lmax0 .lt. params \% pm) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00109}00109             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00110}00110                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00111}00111                 workspace \% tmp\_node\_m(1:constants \% nbasis0, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00112}00112                     \& workspace \% tmp\_sph(1:constants \% nbasis0, isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00113}00113                 workspace \% tmp\_node\_m(constants \% nbasis0+1:, inode) = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00114}00114 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00115}00115         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00116}00116             indl = (params \% pm+1)**2}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00117}00117             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00118}00118                 inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00119}00119                 workspace \% tmp\_node\_m(:, inode) = workspace \% tmp\_sph(1:indl, isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00120}00120 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00121}00121 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00122}00122         \textcolor{comment}{! Do FMM operations}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00123}00123         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_ad0d3d3c1ab770177d8e62b74b7b70a7f}{tree\_m2m\_bessel\_rotation}}(params, constants, workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00124}00124         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a3d18e8fd9f3dbc808deefd71af3c6892}{tree\_m2l\_bessel\_rotation}}(params, constants, workspace \% tmp\_node\_m, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00125}00125             \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00126}00126         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a7d65f9c7b0f00ffce03baa68fbe3cb99}{tree\_l2l\_bessel\_rotation}}(params, constants, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00127}00127         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a0d41a631eb1ddf7d6c96b28919385514}{tree\_l2p\_bessel}}(params, constants, one, workspace \% tmp\_node\_l, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00128}00128             \& workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00129}00129         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a62112cc7d3d77609e0e992504d8be125}{tree\_m2p\_bessel}}(params, constants, constants \% lmax0, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00130}00130             \& params \% lmax, workspace \% tmp\_sph, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00131}00131             \& workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00132}00132         f = -\/(params \% epsp/params \% eps) * constants \% ui * workspace \% tmp\_grid}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00133}00133 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00134}00134 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00135}00135     \textcolor{keyword}{deallocate}(sk\_rijn, dk\_rijn, c0, c1)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00136}00136 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00137}00137 \textcolor{keyword}{end subroutine }wghpot\_f}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00138}00138 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00151}\mbox{\hyperlink{namespaceddx__lpb__core_a27155fbfc41650ee384956aabcf6406c}{00151}} \textcolor{keyword}{subroutine }calcv2\_lpb (params, constants, isph, pot, x, basloc, vplm, vcos, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00152}00152           \& vsin, bessel\_work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00153}00153     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)}  :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00154}00154     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)}  :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00155}00155     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00156}00156 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis, params \% nsph)}, \textcolor{keywordtype}{intent(in)} :: x}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00157}00157 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% ngrid)}, \textcolor{keywordtype}{intent(inout)} :: pot}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00158}00158 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(inout)} :: basloc}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00159}00159 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(inout)} :: vplm}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00160}00160 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% lmax+1)}, \textcolor{keywordtype}{intent(inout)} :: vcos}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00161}00161 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% lmax+1)}, \textcolor{keywordtype}{intent(inout)} :: vsin}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00162}00162     \textcolor{keywordtype}{complex(dp)}, \textcolor{keywordtype}{intent(out)} :: bessel\_work(max(2, params \% lmax+1))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00163}00163     \textcolor{keywordtype}{complex(dp)} :: work\_complex(params \% lmax+1)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00164}00164 \textcolor{keywordtype}{    real}(dp) :: work(params \% lmax+1)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00165}00165 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)} :: fac\_cosmo, fac\_hsp}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00166}00166 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% ngrid)} :: pot2}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00167}00167     \textcolor{keywordtype}{integer} :: its, ij, jsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00168}00168 \textcolor{keywordtype}{    real}(dp) :: rho, ctheta, stheta, cphi, sphi}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00169}00169 \textcolor{keywordtype}{    real}(dp) :: vij(3), sij(3), vtij(3)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00170}00170 \textcolor{keywordtype}{    real}(dp) :: vvij, tij, xij, oij}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00171}00171 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00172}00172     pot = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00173}00173     pot2 = zero}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00174}00174     \textcolor{keywordflow}{do} its = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00175}00175         \textcolor{keywordflow}{if} (constants \% ui(its,isph).lt.one) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00176}00176             \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph+1)-\/1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00177}00177                 jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00178}00178 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00179}00179                 \textcolor{comment}{! compute geometrical variables}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00180}00180                 vij  = params \% csph(:,isph) + params \% rsph(isph)*constants \% cgrid(:,its) -\/ params \% csph(:,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00181}00181                 vvij = sqrt(dot\_product(vij,vij))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00182}00182                 tij  = vvij/params \% rsph(jsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00183}00183 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00184}00184                 \textcolor{keywordflow}{if} ( tij.lt.( one + (params \% se+one)/two*params \% eta ) ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00185}00185                     sij = vij/vvij}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00186}00186                     xij = fsw(tij, params \% se, params \% eta)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00187}00187                     \textcolor{keywordflow}{if} (constants \% fi(its,isph).gt.one) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00188}00188                         oij = xij/constants \% fi(its, isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00189}00189                     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00190}00190                         oij = xij}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00191}00191 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00192}00192                     vtij = vij*params \% kappa}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00193}00193                     \textcolor{keyword}{call }fmm\_l2p\_bessel\_work(vtij, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00194}00194                         \& params \% lmax, constants \% vscales, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00195}00195                         \& constants \% SI\_ri(:, jsph), oij, x(:, jsph), one, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00196}00196                         \& pot(its), work\_complex, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00197}00197 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00198}00198 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00199}00199 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00200}00200 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00201}00201 \textcolor{keyword}{endsubroutine }calcv2\_lpb}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00202}00202 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00210}\mbox{\hyperlink{namespaceddx__lpb__core_ad6dc1419e83a09c20a07880df9d21d72}{00210}} \textcolor{keyword}{subroutine }convert\_ddcosmo(params, constants, direction, vector)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00211}00211     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00212}00212     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00213}00213     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00214}00214     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: direction}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00215}00215     \textcolor{comment}{!! Outputs}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00216}00216 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(inout)} :: vector(constants \% nbasis, params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00217}00217     \textcolor{comment}{!! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00218}00218     \textcolor{keywordtype}{integer} :: isph, l, m, ind}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00219}00219 \textcolor{keywordtype}{    real}(dp) :: fac}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00220}00220     \textcolor{comment}{!! The code}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00221}00221     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00222}00222         \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00223}00223             ind = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00224}00224             fac = fourpi / (two*dble(l) + one) }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00225}00225             \textcolor{keywordflow}{if} (direction .eq. -\/1) fac = one / fac}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00226}00226             \textcolor{keywordflow}{do} m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00227}00227                 vector(ind+m, isph) = fac*vector(ind+m, isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00228}00228 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00229}00229 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00230}00230 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00231}00231 \textcolor{keyword}{end subroutine }convert\_ddcosmo}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00232}00232 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00233}00233 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00245}\mbox{\hyperlink{namespaceddx__lpb__core_a8f0440fba785d6c7b8a8b6d00b62f18d}{00245}} \textcolor{keyword}{subroutine }inthsp(params, constants, rijn, ri, isph, basloc, fac\_hsp, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00246}00246     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00247}00247     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)}  :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00248}00248     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)}  :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00249}00249     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00250}00250 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: rijn, ri}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00251}00251 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(in)} :: basloc}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00252}00252 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(inout)} :: fac\_hsp}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00253}00253     \textcolor{keywordtype}{complex(dp)}, \textcolor{keywordtype}{intent(out)} :: work(max(2, params \% lmax+1))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00254}00254 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(0:params \% lmax)} :: SI\_rijn, DI\_rijn}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00255}00255     \textcolor{keywordtype}{integer} :: l, m, ind}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00256}00256   }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00257}00257     si\_rijn = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00258}00258     di\_rijn = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00259}00259     fac\_hsp = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00260}00260   }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00261}00261     \textcolor{comment}{! Computation of modified spherical Bessel function values}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00262}00262     \textcolor{keyword}{call }modified\_spherical\_bessel\_first\_kind(params \% lmax, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00263}00263         \& rijn*params \% kappa, si\_rijn, di\_rijn, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00264}00264   }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00265}00265     \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00266}00266         \textcolor{keywordflow}{do}  m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00267}00267             ind = l*l + l + 1 + m}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00268}00268             fac\_hsp(ind) = si\_rijn(l)/constants \% SI\_ri(l,isph)*basloc(ind)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00269}00269 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00270}00270 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00271}00271 \textcolor{keyword}{endsubroutine }inthsp}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00272}00272 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00273}00273 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00286}\mbox{\hyperlink{namespaceddx__lpb__core_ab6ff087b76888899139f7712a3b8e419}{00286}} \textcolor{keyword}{subroutine }adjrhs\_lpb(params, constants, workspace, isph, xi, vlm, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00287}00287     \& vplm, vcos, vsin, tmp\_bessel)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00288}00288     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00289}00289     \textcolor{comment}{!! input/output}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00290}00290     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00291}00291     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00292}00292 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% ngrid, params \% nsph)}, \textcolor{keywordtype}{intent(in)} :: xi}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00293}00293 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension((params \% lmax+1)**2)}, \textcolor{keywordtype}{intent(out)} :: vlm}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00294}00294 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension((params \% lmax+1)**2)}, \textcolor{keywordtype}{intent(out)} :: basloc, vplm}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00295}00295 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(params \% lmax+1)}, \textcolor{keywordtype}{intent(out)} :: vcos, vsin}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00296}00296     \textcolor{keywordtype}{complex(dp)}, \textcolor{keywordtype}{dimension(max(2, params \% lmax+1))}, \textcolor{keywordtype}{intent(out)} :: tmp\_bessel}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00297}00297     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00298}00298     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: isph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00299}00299     \textcolor{comment}{!! local}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00300}00300     \textcolor{keywordtype}{integer} :: ij, jsph, ig, l, ind, m}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00301}00301 \textcolor{keywordtype}{    real}(dp) :: vji(3), vvji, tji, sji(3), xji, oji, fac}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00302}00302 \textcolor{keywordtype}{    real}(dp) :: rho, ctheta, stheta, cphi, sphi}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00303}00303 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)} :: fac\_hsp}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00304}00304 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00305}00305     \textcolor{comment}{!loop over neighbors of i-\/sphere}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00306}00306     \textcolor{keywordflow}{do} ij = constants \% inl(isph), constants \% inl(isph+1)-\/1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00307}00307       \textcolor{comment}{!j-\/sphere is neighbor}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00308}00308       jsph = constants \% nl(ij)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00309}00309       \textcolor{comment}{!loop over integration points}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00310}00310       \textcolor{keywordflow}{do} ig = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00311}00311         \textcolor{comment}{!compute t\_n\string^ji = | r\_j + \(\backslash\)rho\_j s\_n -\/ r\_i | / \(\backslash\)rho\_i}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00312}00312         vji  = params \% csph(:,jsph) + params \% rsph(jsph)* \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00313}00313               \& constants \% cgrid(:,ig) -\/ params \% csph(:,isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00314}00314         vvji = sqrt(dot\_product(vji,vji))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00315}00315         tji  = vvji/params \% rsph(isph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00316}00316         \textcolor{comment}{!point is INSIDE i-\/sphere (+ transition layer)}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00317}00317         \textcolor{keywordflow}{if} ( tji.lt.( one + (params \% se+one)/two*params \% eta ) ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00318}00318           \textcolor{comment}{!compute s\_n\string^ji}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00319}00319           sji = vji/vvji}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00320}00320           \textcolor{keyword}{call }ylmbas(sji, rho, ctheta, stheta, cphi, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00321}00321                         \& sphi, params \% lmax, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00322}00322                         \& constants \% vscales, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00323}00323                         \& vplm, vcos, vsin)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00324}00324           \textcolor{keyword}{call }inthsp\_adj(params, constants, vvji, params \% rsph(isph), isph, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00325}00325               \& basloc, fac\_hsp, tmp\_bessel)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00326}00326           \textcolor{comment}{!compute \(\backslash\)chi( t\_n\string^ji )}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00327}00327           xji = fsw( tji, params \% se, params \% eta )}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00328}00328           \textcolor{comment}{!compute W\_n\string^ji}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00329}00329           \textcolor{keywordflow}{if} ( constants \% fi(ig,jsph).gt.one ) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00330}00330             oji = xji/ constants \% fi(ig,jsph)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00331}00331           \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00332}00332             oji = xji}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00333}00333 \textcolor{keywordflow}{          endif}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00334}00334           \textcolor{comment}{!compute w\_n * xi(n,j) * W\_n\string^ji}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00335}00335           fac = constants \% wgrid(ig) * xi(ig,jsph) * oji}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00336}00336           \textcolor{comment}{!loop over l}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00337}00337           \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00338}00338             ind  = l*l + l + 1}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00339}00339             \textcolor{comment}{!loop over m}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00340}00340               \textcolor{keywordflow}{do} m = -\/l,l}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00341}00341                 vlm(ind+m) = vlm(ind+m) + fac*fac\_hsp(ind+m)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00342}00342 \textcolor{keywordflow}{              enddo}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00343}00343 \textcolor{keywordflow}{          enddo}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00344}00344 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00345}00345 \textcolor{keywordflow}{      enddo}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00346}00346 \textcolor{keywordflow}{    enddo}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00347}00347 \textcolor{keyword}{end subroutine }adjrhs\_lpb}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00348}00348 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00349}00349 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00360}\mbox{\hyperlink{namespaceddx__lpb__core_ac82b16767440bcb1045ba7d9e1498e45}{00360}} \textcolor{keyword}{subroutine }inthsp\_adj(params, constants, rjin, rj, jsph, basloc, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00361}00361           \& fac\_hsp, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00362}00362     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00363}00363     \textcolor{comment}{!! Inputs}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00364}00364     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00365}00365     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00366}00366     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: jsph}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00367}00367 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(in)} :: rjin, rj}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00368}00368 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(in)} :: basloc}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00369}00369 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(constants \% nbasis)}, \textcolor{keywordtype}{intent(inout)} :: fac\_hsp}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00370}00370     \textcolor{keywordtype}{complex(dp)}, \textcolor{keywordtype}{intent(out)} :: work(max(2, params \% lmax+1))}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00371}00371 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{dimension(0:params \% lmax)} :: SI\_rjin, DI\_rjin}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00372}00372     \textcolor{keywordtype}{integer} :: l, m, ind}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00373}00373 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00374}00374     si\_rjin = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00375}00375     di\_rjin = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00376}00376     fac\_hsp = 0}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00377}00377 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00378}00378     \textcolor{comment}{! Computation of modified spherical Bessel function values}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00379}00379     \textcolor{keyword}{call }modified\_spherical\_bessel\_first\_kind(params \% lmax, \&}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00380}00380         \& rjin*params \% kappa, si\_rjin, di\_rjin, work)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00381}00381 }
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00382}00382     \textcolor{keywordflow}{do} l = 0, params \% lmax}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00383}00383       \textcolor{keywordflow}{do}  m = -\/l, l}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00384}00384         ind = l*l + l + 1 + m}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00385}00385         fac\_hsp(ind) = si\_rjin(l)/constants \% SI\_ri(l,jsph)*basloc(ind)}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00386}00386 \textcolor{keywordflow}{      end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00387}00387 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00388}00388 \textcolor{keyword}{endsubroutine }inthsp\_adj}
\DoxyCodeLine{\Hypertarget{ddx__lpb__core_8f90_source_l00389}00389 \textcolor{keyword}{end module }\mbox{\hyperlink{namespaceddx__lpb__core}{ddx\_lpb\_core}}}

\end{DoxyCode}
