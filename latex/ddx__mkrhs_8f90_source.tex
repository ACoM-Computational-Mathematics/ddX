\hypertarget{ddx__mkrhs_8f90_source}{}\doxysection{ddx\+\_\+mkrhs.\+f90}
\label{ddx__mkrhs_8f90_source}\index{src/ddx\_mkrhs.f90@{src/ddx\_mkrhs.f90}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00017}00017 \textcolor{keyword}{subroutine }mkrhs(params, constants, workspace, phi\_flag, phi\_cav, grad\_flag, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00018}00018         \& gradphi\_cav, hessian\_flag, hessianphi\_cav, psi)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00019}00019     \textcolor{keywordtype}{use }\mbox{\hyperlink{namespaceddx__core}{ddx\_core}}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00020}00020     \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00021}00021     \textcolor{keywordtype}{type}(ddx\_params\_type), \textcolor{keywordtype}{intent(in)} :: params}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00022}00022     \textcolor{keywordtype}{type}(ddx\_workspace\_type), \textcolor{keywordtype}{intent(inout)} :: workspace}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00023}00023     \textcolor{keywordtype}{type}(ddx\_constants\_type), \textcolor{keywordtype}{intent(in)} :: constants}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00024}00024     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: phi\_flag, grad\_flag, hessian\_flag}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00025}00025 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: phi\_cav(constants \% ncav)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00026}00026 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: gradphi\_cav(3, constants \% ncav)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00027}00027 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: hessianphi\_cav(3, 3, constants \% ncav)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00028}00028 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{intent(out)} :: psi(constants \% nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00029}00029         \& params \% nsph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00030}00030     \textcolor{comment}{! Local variables}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00031}00031     \textcolor{keywordtype}{integer} :: isph, igrid, icav, inode, inear, jnear, jnode, jsph, i}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00032}00032 \textcolor{keywordtype}{    real}(dp) :: d(3), v, tmpv, r, gradv(3), hessianv(3, 3), tmpd(3), epsp=one}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00033}00033 \textcolor{keywordtype}{    real}(dp), \textcolor{keywordtype}{allocatable} :: grid\_grad(:,:,:), grid\_hessian(:,:,:,:), \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00034}00034         \& grid\_hessian2(:,:,:)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00035}00035     \textcolor{keywordtype}{real(dp)}, \textcolor{keywordtype}{external} :: dnrm2}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00036}00036 \textcolor{keywordtype}{    real}(dp) :: t}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00037}00037 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00038}00038     \textcolor{keywordflow}{if} (grad\_flag .eq. 1) \textcolor{keyword}{allocate}(grid\_grad(params \% ngrid, 3, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00039}00039         \& params \% nsph))}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00040}00040     \textcolor{keywordflow}{if} (hessian\_flag .eq. 1) \textcolor{keyword}{allocate}(grid\_hessian(params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00041}00041         \& 3, 3, params \% nsph), grid\_hessian2(params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00042}00042         \& 3, params \% nsph))}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00043}00043 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00044}00044     \textcolor{comment}{! In case FMM is disabled compute phi and gradphi at cavity points by a}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00045}00045     \textcolor{comment}{! naive double loop of a quadratic complexity}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00046}00046     \textcolor{keywordflow}{if} (params \% fmm .eq. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00047}00047         \textcolor{keywordflow}{do} icav = 1, constants \% ncav}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00048}00048             v = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00049}00049             gradv = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00050}00050             hessianv = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00051}00051             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00052}00052                 d = constants \% ccav(:, icav) -\/ \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00053}00053                     \& params \% csph(:, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00054}00054                 r = dnrm2(3, d, 1)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00055}00055                 d = d / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00056}00056                 tmpv = params \% charge(isph) / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00057}00057                 v = v + tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00058}00058                 tmpv = tmpv / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00059}00059                 tmpd = tmpv * d}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00060}00060                 tmpv = tmpv / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00061}00061                 gradv = gradv -\/ tmpd}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00062}00062                 tmpd = three / r * tmpd}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00063}00063                 hessianv(:, 1) = hessianv(:, 1) + tmpd*d(1)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00064}00064                 hessianv(:, 2) = hessianv(:, 2) + tmpd*d(2)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00065}00065                 hessianv(:, 3) = hessianv(:, 3) + tmpd*d(3)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00066}00066                 hessianv(1, 1) = hessianv(1, 1) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00067}00067                 hessianv(2, 2) = hessianv(2, 2) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00068}00068                 hessianv(3, 3) = hessianv(3, 3) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00069}00069 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00070}00070             \textcolor{keywordflow}{if} (phi\_flag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00071}00071                 phi\_cav(icav) = v}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00072}00072 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00073}00073             \textcolor{keywordflow}{if} (grad\_flag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00074}00074                 gradphi\_cav(:, icav) = gradv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00075}00075 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00076}00076             \textcolor{keywordflow}{if} (hessian\_flag .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00077}00077                 hessianphi\_cav(:, :, icav) = hessianv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00078}00078 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00079}00079 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00080}00080     \textcolor{comment}{! Use the FMM otherwise}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00081}00081     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00082}00082         \textcolor{comment}{! P2M step from centers of harmonics}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00083}00083         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00084}00084             inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00085}00085             workspace \% tmp\_sph(1, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00086}00086                 \& params \% charge(isph) \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00087}00087                 \& / params \% rsph(isph) / sqrt4pi}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00088}00088             workspace \% tmp\_sph(2:, isph) = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00089}00089             workspace \% tmp\_node\_m(1, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00090}00090                 \& workspace \% tmp\_sph(1, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00091}00091             workspace \% tmp\_node\_m(2:, inode) = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00092}00092 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00093}00093         \textcolor{comment}{! M2M, M2L and L2L translations}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00094}00094 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00095}00095         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a1caf6da4500220161384b51938ada1f8}{tree\_m2m\_rotation}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00096}00096             \& workspace \% tmp\_node\_m)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00097}00097 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00098}00098         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a559f8f129ce2d481446c4325526aa277}{tree\_m2l\_rotation}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00099}00099             \& workspace \% tmp\_node\_m, workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00100}00100 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00101}00101         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a144b53f7df72de5a2717b78c6b903160}{tree\_l2l\_rotation}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00102}00102             \& workspace \% tmp\_node\_l)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00103}00103 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00104}00104         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a1d81120958f62351b12a9036ab6cbf6e}{tree\_l2p}}(params, constants, one, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00105}00105             \& workspace \% tmp\_node\_l, zero, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00106}00106             \& workspace \% tmp\_grid, workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00107}00107 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00108}00108         \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a60a40706c306b954af9fccb186c305e0}{tree\_m2p}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00109}00109             \& params \% lmax, one, workspace \% tmp\_sph, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00110}00110             \& one, workspace \% tmp\_grid)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00111}00111 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00112}00112         \textcolor{comment}{! Potential from each sphere to its own grid points}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00113}00113         \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, params \% nsph, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00114}00114             \& constants \% nbasis, one, constants \% vgrid2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00115}00115             \& constants \% vgrid\_nbasis, workspace \% tmp\_sph, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00116}00116             \& constants \% nbasis, one, workspace \% tmp\_grid, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00117}00117             \& params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00118}00118 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00119}00119         \textcolor{comment}{! Rearrange potential from all grid points to external only}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00120}00120         \textcolor{keywordflow}{if} (phi\_flag.eq.1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00121}00121             icav = 0}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00122}00122             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00123}00123                 \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00124}00124                     \textcolor{comment}{! Do not count internal grid points}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00125}00125                     \textcolor{keywordflow}{if}(constants \% ui(igrid, isph) .eq. zero) cycle}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00126}00126                     icav = icav + 1}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00127}00127                     phi\_cav(icav) = workspace \% tmp\_grid(igrid, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00128}00128 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00129}00129 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00130}00130 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00131}00131 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00132}00132         \textcolor{comment}{! Now compute near-\/field FMM gradients and hessians}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00133}00133         \textcolor{comment}{! Cycle over all spheres}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00134}00134         \textcolor{keywordflow}{if} (grad\_flag.eq.1 .or. hessian\_flag.eq.1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00135}00135             \textcolor{keywordflow}{if} (grad\_flag.eq.1) grid\_grad(:, :, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00136}00136             \textcolor{keywordflow}{if} (hessian\_flag.eq.1) grid\_hessian(:, :, :, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00137}00137             \textcolor{comment}{!\$omp parallel do default(none) shared(params,constants,workspace, \&}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00138}00138             \textcolor{comment}{!\$omp grid\_grad,grid\_hessian,grad\_flag,hessian\_flag) \&}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00139}00139             \textcolor{comment}{!\$omp private(isph,igrid,inode,jnear,jnode,jsph,d,r,tmpd,tmpv) \&}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00140}00140             \textcolor{comment}{!\$omp schedule(dynamic)}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00141}00141             \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00142}00142                 \textcolor{comment}{! Cycle over all external grid points}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00143}00143                 \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00144}00144                     \textcolor{keywordflow}{if}(constants \% ui(igrid, isph) .eq. zero) cycle}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00145}00145                     \textcolor{comment}{! Cycle over all near-\/field admissible pairs of spheres,}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00146}00146                     \textcolor{comment}{! including pair (isph, isph) which is a self-\/interaction}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00147}00147                     inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00148}00148                     \textcolor{keywordflow}{do} jnear = constants \% snear(inode), \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00149}00149                         \& constants \% snear(inode+1) -\/ 1}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00150}00150                         \textcolor{comment}{! Near-\/field interactions are possible only between leaf}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00151}00151                         \textcolor{comment}{! nodes, which must contain only a single input sphere}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00152}00152                         jnode = constants \% near(jnear)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00153}00153                         jsph = constants \% order( \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00154}00154                             \& constants \% cluster(1, jnode))}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00155}00155                         d = params \% csph(:, isph) + \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00156}00156                             \& constants \% cgrid(:, igrid) \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00157}00157                             \& *params \% rsph(isph) \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00158}00158                             \& -\/ params \% csph(:, jsph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00159}00159 \textcolor{comment}{!                       r = dnrm2(3, d, 1)}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00160}00160                         r = sqrt(d(1)*d(1) + d(2)*d(2) + d(3)*d(3))}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00161}00161                         d = d / r / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00162}00162                         tmpv = params \% charge(jsph) / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00163}00163                         \textcolor{keywordflow}{if} (grad\_flag.eq.1) grid\_grad(igrid, :, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00164}00164                             \& grid\_grad(igrid, :, isph) -\/ tmpv * d}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00165}00165                         tmpd = three * tmpv * d}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00166}00166                         tmpv = tmpv / r / r}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00167}00167                         \textcolor{keywordflow}{if} (hessian\_flag.eq.1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00168}00168                             grid\_hessian(igrid, 1, :, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00169}00169                                 \& grid\_hessian(igrid, 1, :, isph) + d(1)*tmpd}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00170}00170                             grid\_hessian(igrid, 2, :, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00171}00171                                 \& grid\_hessian(igrid, 2, :, isph) + d(2)*tmpd}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00172}00172                             grid\_hessian(igrid, 3, :, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00173}00173                                 \& grid\_hessian(igrid, 3, :, isph) + d(3)*tmpd}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00174}00174                             grid\_hessian(igrid, 1, 1, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00175}00175                                 \& grid\_hessian(igrid, 1, 1, isph) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00176}00176                             grid\_hessian(igrid, 2, 2, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00177}00177                                 \& grid\_hessian(igrid, 2, 2, isph) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00178}00178                             grid\_hessian(igrid, 3, 3, isph) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00179}00179                                 \& grid\_hessian(igrid, 3, 3, isph) -\/ tmpv}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00180}00180 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00181}00181 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00182}00182 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00183}00183 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00184}00184 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00185}00185 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00186}00186         \textcolor{comment}{! Take into account far-\/field FMM gradients only if pl > 0}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00187}00187         \textcolor{keywordflow}{if} ((params \% pl .gt. 0) .and. (grad\_flag.eq.1)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00188}00188             \textcolor{comment}{! Get gradient of L2L}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00189}00189             \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a0bbe738fff5a4d15f744dfa0b26938cf}{tree\_grad\_l2l}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00190}00190                 \& workspace \% tmp\_node\_l, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00191}00191                 \& workspace \% tmp\_sph\_l\_grad, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00192}00192                 \& workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00193}00193             \textcolor{comment}{! Apply L2P for every axis with -\/1 multiplier since grad over}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00194}00194             \textcolor{comment}{! target point is equal to grad over source point}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00195}00195             \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00196}00196                 \& 3*params \% nsph, (params \% pl)**2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00197}00197                 \& -\/one, constants \% vgrid2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00198}00198                 \& constants \% vgrid\_nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00199}00199                 \& workspace \% tmp\_sph\_l\_grad, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00200}00200                 \& (params \% pl+1)**2, one, grid\_grad, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00201}00201                 \& params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00202}00202 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00203}00203         \textcolor{comment}{! Take into account far-\/field FMM hessians only if pl > 1}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00204}00204         \textcolor{keywordflow}{if} ((params \% pl .gt. 1) .and. (hessian\_flag.eq.1)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00205}00205             \textcolor{keywordflow}{do} i = 1, 3}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00206}00206                 \textcolor{comment}{! Load previously computed gradient into leaves, since}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00207}00207                 \textcolor{comment}{! tree\_grad\_l2l currently takes local expansions of entire}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00208}00208                 \textcolor{comment}{! tree. In future it might be changed.}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00209}00209                 \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00210}00210                     inode = constants \% snode(isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00211}00211                     workspace \% tmp\_node\_l(:, inode) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00212}00212                         \& workspace \% tmp\_sph\_l\_grad(:, i, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00213}00213 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00214}00214                 \textcolor{comment}{! Get gradient of a gradient of L2L. Currently this uses input}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00215}00215                 \textcolor{comment}{! pl maximal degree of local harmonics but in reality we need}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00216}00216                 \textcolor{comment}{! only pl-\/1 maximal degree since coefficients of harmonics of a}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00217}00217                 \textcolor{comment}{! degree pl are zeros.}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00218}00218                 \textcolor{keyword}{call }\mbox{\hyperlink{namespaceddx__core_a0bbe738fff5a4d15f744dfa0b26938cf}{tree\_grad\_l2l}}(params, constants, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00219}00219                     \& workspace \% tmp\_node\_l, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00220}00220                     \& workspace \% tmp\_sph\_l\_grad2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00221}00221                     \& workspace \% tmp\_sph\_l)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00222}00222                 \textcolor{comment}{! Apply L2P for every axis}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00223}00223                 \textcolor{keyword}{call }dgemm(\textcolor{stringliteral}{'T'}, \textcolor{stringliteral}{'N'}, params \% ngrid, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00224}00224                     \& 3*params \% nsph, (params \% pl-\/1)**2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00225}00225                     \& one, constants \% vgrid2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00226}00226                     \& constants \% vgrid\_nbasis, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00227}00227                     \& workspace \% tmp\_sph\_l\_grad2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00228}00228                     \& (params \% pl+1)**2, zero, grid\_hessian2, \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00229}00229                     \& params \% ngrid)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00230}00230                 \textcolor{comment}{! Properly copy hessian}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00231}00231                 grid\_hessian(:, i, :, :) = grid\_hessian(:, i, :, :) + grid\_hessian2}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00232}00232 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00233}00233 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00234}00234 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00235}00235         \textcolor{comment}{! Copy output for external grid points only}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00236}00236         icav = 0}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00237}00237         \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00238}00238             \textcolor{keywordflow}{do} igrid = 1, params \% ngrid}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00239}00239                 \textcolor{keywordflow}{if}(constants \% ui(igrid, isph) .eq. zero) cycle}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00240}00240                 icav = icav + 1}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00241}00241                 \textcolor{keywordflow}{if} (grad\_flag .eq. 1) gradphi\_cav(:, icav) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00242}00242                     \& grid\_grad(igrid, :, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00243}00243                 \textcolor{keywordflow}{if} (hessian\_flag .eq. 1) hessianphi\_cav(:, :, icav) = \&}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00244}00244                     \& grid\_hessian(igrid, :, :, isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00245}00245 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00246}00246 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00247}00247 \textcolor{keywordflow}{    end if}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00248}00248 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00249}00249     \textcolor{comment}{! Vector psi}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00250}00250     psi(2:, :) = zero}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00251}00251     \textcolor{keywordflow}{do} isph = 1, params \% nsph}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00252}00252         psi(1, isph) = sqrt4pi * params \% charge(isph)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00253}00253 \textcolor{keywordflow}{    end do}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00254}00254 }
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00255}00255     \textcolor{comment}{! deallocate temporary}}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00256}00256     \textcolor{keywordflow}{if} (grad\_flag .eq. 1) \textcolor{keyword}{deallocate}(grid\_grad)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00257}00257     \textcolor{keywordflow}{if} (hessian\_flag .eq. 1) \textcolor{keyword}{deallocate}(grid\_hessian, grid\_hessian2)}
\DoxyCodeLine{\Hypertarget{ddx__mkrhs_8f90_source_l00258}00258 \textcolor{keyword}{end subroutine }mkrhs}

\end{DoxyCode}
